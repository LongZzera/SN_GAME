<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SN THE GAME - Tools Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', monospace; user-select: none; }
        canvas { display: block; image-rendering: pixelated; cursor: none; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Status Bars */
        .status-container { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; }
        .hud-row { display: flex; gap: 4px; }
        
        .heart { 
            width: 20px; height: 20px; background: #d32f2f; 
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 50% 80%, 18% 100%, 0% 38%);
            border: 2px solid #5a1010; box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }
        
        .armor-icon-hud {
            width: 20px; height: 20px; background: #bbb; 
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 100%, 0% 100%, 0% 20%);
            border: 2px solid #444; box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }

        .food-icon {
            width: 16px; height: 16px; background: #ff9800; border-radius: 50%;
            border: 2px solid #e65100; box-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            position: relative;
        }
        .food-icon::after {
            content: ''; position: absolute; top: 2px; right: 2px; width: 4px; height: 4px; 
            background: #ffe0b2; border-radius: 50%;
        }
        .food-missing { background: #3e2723; border-color: #1a1a1a; opacity: 0.5; }

        /* Hotbar */
        #hud-hotbar { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 6px; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 8px; border-radius: 8px; border: 2px solid #444;
        }

        /* Inventory */
        #inventory-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none; 
            justify-content: center; align-items: center; pointer-events: auto; z-index: 50;
        }

        .inventory-window {
            background: #c6c6c6; border: 4px solid #fff; outline: 4px solid #000;
            padding: 20px; display: flex; gap: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            image-rendering: pixelated; border-radius: 2px; position: relative;
        }

        .close-btn {
            position: absolute; top: 5px; right: 5px; 
            width: 24px; height: 24px; background: #d32f2f; color: white;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            border: 2px solid #000; font-weight: bold;
        }
        .close-btn:hover { background: #ff5252; }

        .inv-panel { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .panel-title { 
            color: #333; font-weight: bold; font-size: 18px; margin: 0; 
            padding-bottom: 5px; border-bottom: 2px solid #555; text-transform: uppercase; 
        }
        
        .slot-grid {
            display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px;
            background: #8b8b8b; padding: 4px; border: 2px solid #fff; border-right-color: #373737; border-bottom-color: #373737;
        }
        .crafting-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;
            background: #8b8b8b; padding: 4px; border: 2px solid #fff; border-right-color: #373737; border-bottom-color: #373737;
            max-height: 280px; overflow-y: auto; width: 180px;
        }
        
        /* Armor Slots Column */
        .armor-column {
            display: flex; flex-direction: column; gap: 10px;
            background: #8b8b8b; padding: 10px; border: 2px solid #fff; border-right-color: #373737; border-bottom-color: #373737;
            align-items: center;
        }

        .slot { 
            width: 40px; height: 40px; background: #8b8b8b; 
            border: 2px solid #373737; border-right-color: #fff; border-bottom-color: #fff;
            position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .slot:hover { background: #a0a0a0; }
        .slot.active { background: #bdbdbd; border-color: #ffd700; transform: scale(1.1); z-index: 10; box-shadow: 0 0 10px #ffd700; }
        
        .slot-placeholder {
            position: absolute; opacity: 0.3; font-size: 20px; pointer-events: none;
        }

        .trash-slot { background: #ffcccc; border-color: #d32f2f; }
        .trash-slot:hover { background: #ff5252; }

        .item-icon { font-size: 24px; pointer-events: none; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5)); }
        .item-block { width: 24px; height: 24px; border: 2px solid rgba(0,0,0,0.3); pointer-events: none; box-shadow: 2px 2px 0 rgba(0,0,0,0.4); }
        .item-count { 
            position: absolute; bottom: 1px; right: 2px; 
            color: #fff; text-shadow: 1px 1px 0 #000; font-weight: bold; font-size: 11px; pointer-events: none;
        }
        .slot-key { position: absolute; top: 1px; left: 2px; color: #555; font-size: 9px; pointer-events: none; }

        #tooltip {
            position: absolute; display: none; background: rgba(10, 10, 16, 0.95); border: 2px solid #7e57c2;
            color: #fff; padding: 10px; border-radius: 4px; z-index: 200; pointer-events: none;
            max-width: 220px; font-size: 12px; box-shadow: 0 5px 15px black;
        }
        #tooltip h4 { margin: 0 0 5px 0; color: #ffd700; border-bottom: 1px solid #444; }
        #tooltip .cost-item { display: flex; justify-content: space-between; color: #ccc; }
        #tooltip .cost-ok { color: #66bb6a; } #tooltip .cost-no { color: #ef5350; }
        #tooltip .stats { color: #aaa; margin-top: 5px; font-style: italic; border-top: 1px solid #333; padding-top: 2px;}

        #cursor-item {
            position: fixed; pointer-events: none; z-index: 999;
            width: 40px; height: 40px; display: none;
            justify-content: center; align-items: center;
        }

        #hero-select {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a237e, #000); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; pointer-events: auto;
        }
        .hero-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 30px;}
        .hero-btn {
            width: 80px; height: 100px; border: 2px solid rgba(255,255,255,0.5); 
            background: rgba(0,0,0,0.4); cursor: pointer; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: bold; font-size: 12px;
        }
        .hero-btn:hover { background: rgba(255,255,255,0.2); border-color: #ffd700; transform: translateY(-5px); }

        #message-area {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); 
            color: #fff; font-size: 18px; font-weight: bold; text-shadow: 2px 2px 0 #000; 
            pointer-events: none; opacity: 0; transition: opacity 0.5s;
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
        }
        #controls-hint {
            position: absolute; top: 10px; right: 10px; color: #ccc; text-align: right; 
            font-size: 11px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 4px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="hero-select">
        <h1 style="color:#ffd700; text-shadow:4px 4px 0 #000; font-size:50px; margin:0;">SN THE GAME</h1>
        <div class="hero-grid" id="hero-grid"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="controls-hint">
            WASD: Mover | Espa√ßo: Pular/Nadar<br>
            Mouse Esq: Quebrar/Atacar<br>
            Mouse Dir: Colocar Bloco/Comer<br>
            E: Mochila | Q: Dropar<br>
            Shift+Click: Mover R√°pido
        </div>
        
        <div class="status-container">
            <div class="hud-row" id="health-bar"></div>
            <div class="hud-row" id="armor-bar" style="margin-top:2px;"></div>
            <div class="hud-row" id="hunger-bar"></div>
        </div>

        <div id="hud-hotbar"></div>

        <div id="inventory-screen">
            <div class="inventory-window">
                <div class="close-btn" onclick="toggleInventory()">X</div>
                
                <div class="inv-panel">
                    <h3 class="panel-title">Criar</h3>
                    <div id="crafting-grid" class="crafting-grid"></div>
                </div>

                <div class="inv-panel">
                    <h3 class="panel-title">Equipamento</h3>
                    <div class="armor-column">
                        <div class="slot" id="armor-slot-0" onclick="armorSlotClick(0)" title="Capacete">
                            <div class="slot-placeholder">ü™ñ</div>
                        </div>
                        <div class="slot" id="armor-slot-1" onclick="armorSlotClick(1)" title="Peitoral">
                            <div class="slot-placeholder">üëï</div>
                        </div>
                        <div class="slot" id="armor-slot-2" onclick="armorSlotClick(2)" title="Cal√ßa">
                            <div class="slot-placeholder">üëñ</div>
                        </div>
                        <div class="slot" id="armor-slot-3" onclick="armorSlotClick(3)" title="Botas">
                            <div class="slot-placeholder">üë¢</div>
                        </div>
                    </div>
                </div>

                <div class="inv-panel">
                    <h3 class="panel-title">Mochila</h3>
                    <div class="slot-grid" id="main-inventory-grid"></div>
                    <div style="height: 10px;"></div>
                    <h3 class="panel-title" style="font-size: 14px; border:none; padding:0;">Atalhos</h3>
                    <div style="display: flex; gap: 10px;">
                        <div class="slot-grid" id="inv-hotbar-grid"></div>
                        <div class="slot trash-slot" title="Lixeira" onmouseup="handleTrashDrop()">
                            <div class="item-icon">üóëÔ∏è</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="message-area"></div>
        <div id="tooltip"></div>
        <div id="cursor-item"></div>
    </div>

<script>
/** SN THE GAME - TOOLS UPDATE **/

const HEROES = [
    { name: "Jp", color: "#FFA500" }, { name: "Edu", color: "#ADD8E6" },
    { name: "Torugo", color: "#FFFFFF" }, { name: "Shootery", color: "#800080" },
    { name: "N3to", color: "#00008B" }, { name: "Long", color: "#00FFFF" },
    { name: "King", color: "#FF0000" }, { name: "Meisu", color: "#8B4513" },
    { name: "Trequim_", color: "#FFFF00" }, { name: "Towid", color: "#FF69B4" }
];

const BLOCK_SIZE = 32;
const CHUNK_WIDTH = 16;
const CHUNK_HEIGHT = 140; 
const GRAVITY = 0.5;
const TERMINAL_VELOCITY = 15;
const SEA_LEVEL = 55;

// Block IDs
const B_AIR=0, B_DIRT=1, B_GRASS=2, B_STONE=3, B_WOOD=4, B_LEAVES=5, B_LOG=6, B_COAL=7, 
      B_IRON=8, B_GOLD=9, B_DIAMOND=10, B_BEDROCK=11, B_HELLSTONE=12, B_BRICK=13, 
      B_PORTAL_NETHER=14, B_PLANKS=15, B_TORCH=16, B_FLOWER=17, B_TALLGRASS=18,
      B_COPPER=19, B_AMETHYST=20, B_WATER=21, B_SAND=22, 
      B_EMERALD=23, B_RUBY=24, B_TITANIUM=25,
      B_GLOWSTONE=26, B_SNOW=27, B_IRON_BARS=28,
      B_PORTAL_AETHER=29, B_PORTAL_PRISON=30, B_PORTAL_EVEREST=31, B_REDSTONE=32;

// Item IDs
const ITEM_MAGIC_STAFF=100, ITEM_BACON=101, ITEM_STEAK=105;
const ITEM_WOOL=110, ITEM_CHICKEN_RAW=111, ITEM_STRING=112;

// Tools (Pickaxes & Swords)
const ITEM_WOOD_PICKAXE=200, ITEM_WOOD_SWORD=201;
const ITEM_STONE_PICKAXE=202, ITEM_STONE_SWORD=203;
const ITEM_COPPER_PICKAXE=204, ITEM_COPPER_SWORD=205;
const ITEM_IRON_PICKAXE=206, ITEM_IRON_SWORD=207;
const ITEM_AMETHYST_PICKAXE=208, ITEM_AMETHYST_SWORD=209;
const ITEM_DIAMOND_PICKAXE=210, ITEM_DIAMOND_SWORD=211;
const ITEM_SURREAL_PICKAXE=212, ITEM_SURREAL_SWORD=213;
const ITEM_EMERALD_PICKAXE=214, ITEM_EMERALD_SWORD=215;
const ITEM_RUBY_PICKAXE=216, ITEM_RUBY_SWORD=217;
const ITEM_TITANIUM_PICKAXE=218, ITEM_TITANIUM_SWORD=219;

// New Tools: Axes (Machados), Sickles (Foices), Knives (Facas)
const ITEM_WOOD_AXE=400, ITEM_STONE_AXE=401, ITEM_COPPER_AXE=402, ITEM_IRON_AXE=403, ITEM_AMETHYST_AXE=404, ITEM_EMERALD_AXE=405, ITEM_RUBY_AXE=406, ITEM_DIAMOND_AXE=407, ITEM_TITANIUM_AXE=408, ITEM_SURREAL_AXE=409;
const ITEM_WOOD_SICKLE=420, ITEM_STONE_SICKLE=421, ITEM_COPPER_SICKLE=422, ITEM_IRON_SICKLE=423, ITEM_AMETHYST_SICKLE=424, ITEM_EMERALD_SICKLE=425, ITEM_RUBY_SICKLE=426, ITEM_DIAMOND_SICKLE=427, ITEM_TITANIUM_SICKLE=428, ITEM_SURREAL_SICKLE=429;
const ITEM_WOOD_KNIFE=440, ITEM_STONE_KNIFE=441, ITEM_COPPER_KNIFE=442, ITEM_IRON_KNIFE=443, ITEM_AMETHYST_KNIFE=444, ITEM_EMERALD_KNIFE=445, ITEM_RUBY_KNIFE=446, ITEM_DIAMOND_KNIFE=447, ITEM_TITANIUM_KNIFE=448, ITEM_SURREAL_KNIFE=449;

// --- ARMADURAS ---
// Formato: 3XX. 0=Helm, 1=Chest, 2=Legs, 3=Boots
const ARMOR_STONE_HELM=300, ARMOR_STONE_CHEST=301, ARMOR_STONE_LEGS=302, ARMOR_STONE_BOOTS=303;
const ARMOR_COPPER_HELM=310, ARMOR_COPPER_CHEST=311, ARMOR_COPPER_LEGS=312, ARMOR_COPPER_BOOTS=313;
const ARMOR_IRON_HELM=320, ARMOR_IRON_CHEST=321, ARMOR_IRON_LEGS=322, ARMOR_IRON_BOOTS=323;
const ARMOR_AMETHYST_HELM=330, ARMOR_AMETHYST_CHEST=331, ARMOR_AMETHYST_LEGS=332, ARMOR_AMETHYST_BOOTS=333;
const ARMOR_DIAMOND_HELM=340, ARMOR_DIAMOND_CHEST=341, ARMOR_DIAMOND_LEGS=342, ARMOR_DIAMOND_BOOTS=343;
const ARMOR_SURREAL_HELM=350, ARMOR_SURREAL_CHEST=351, ARMOR_SURREAL_LEGS=352, ARMOR_SURREAL_BOOTS=353;
const ARMOR_REDSTONE_HELM=360, ARMOR_REDSTONE_CHEST=361, ARMOR_REDSTONE_LEGS=362, ARMOR_REDSTONE_BOOTS=363;

const BLOCK_HARDNESS = {
    [B_DIRT]: 15, [B_GRASS]: 15, [B_STONE]: 50, [B_WOOD]: 30, [B_LEAVES]: 5, 
    [B_LOG]: 40, [B_COAL]: 60, [B_IRON]: 80, [B_GOLD]: 90, [B_DIAMOND]: 120, 
    [B_BEDROCK]: 99999, [B_HELLSTONE]: 100, [B_BRICK]: 60, 
    [B_PORTAL_NETHER]: 80, [B_PORTAL_AETHER]: 80, [B_PORTAL_PRISON]: 80, [B_PORTAL_EVEREST]: 80,
    [B_PLANKS]: 30, [B_TORCH]: 1, [B_FLOWER]: 1, [B_TALLGRASS]: 1,
    [B_COPPER]: 60, [B_AMETHYST]: 100, [B_SAND]: 15, [B_WATER]: 99999,
    [B_EMERALD]: 110, [B_RUBY]: 130, [B_TITANIUM]: 150,
    [B_GLOWSTONE]: 40, [B_SNOW]: 10, [B_IRON_BARS]: 90, [B_REDSTONE]: 70
};

const COLORS = {
    [B_DIRT]: '#795548',       // Marrom Terra
    [B_GRASS]: '#43a047',      // Verde Vivo
    [B_STONE]: '#546e7a',      // Cinza Azulado (Pedra)
    [B_WOOD]: '#8d6e63',       // Madeira Clara
    [B_LEAVES]: '#2e7d32',     // Verde Escuro
    [B_LOG]: '#3e2723',        // Madeira Escura
    [B_COAL]: '#212121',       // Preto Carv√£o
    [B_IRON]: '#b0bec5',       // Prata (Ferro)
    [B_GOLD]: '#ffc107',       // Ouro Brilhante
    [B_DIAMOND]: '#00e5ff',    // Ciano Neon
    [B_BEDROCK]: '#000000',    // Preto Absoluto
    [B_HELLSTONE]: '#b71c1c',  // Vermelho Sangue
    [B_BRICK]: '#5d4037',      // Tijolo Escuro
    [B_PORTAL_NETHER]: '#7b1fa2', // Roxo M√°gico
    [B_PLANKS]: '#a1887f',     // T√°buas
    [B_TORCH]: '#ffeb3b',      // Amarelo Luz
    [B_FLOWER]: '#e91e63',     // Rosa Flor
    [B_TALLGRASS]: '#7cb342',  // Verde Planta
    [B_COPPER]: '#ff7043',     // Laranja Cobre
    [B_AMETHYST]: '#d500f9',   // Roxo Brilhante
    [B_WATER]: 'rgba(33, 150, 243, 0.6)', // Azul Transl√∫cido
    [B_SAND]: '#fff59d',       // Areia Clara
    [B_EMERALD]: '#00c853',    // Verde Esmeralda
    [B_RUBY]: '#ff1744',       // Vermelho Rubi
    [B_TITANIUM]: '#78909c',   // Metal Azulado
    [B_GLOWSTONE]: '#fff176',  // Luz Divina
    [B_SNOW]: '#ffffff',       // Branco Neve
    [B_IRON_BARS]: '#455a64',  // Grades Escuras
    [B_PORTAL_AETHER]: '#81d4fa', // Azul C√©u
    [B_PORTAL_PRISON]: '#37474f', // Cinza Pris√£o
    [B_PORTAL_EVEREST]: '#b2ebf2', // Gelo
    [B_REDSTONE]: '#ff1744'    // Vermelho Redstone
};

const ITEM_DATA = {
    [B_DIRT]: { name: "Terra", color: COLORS[B_DIRT] },
    [B_GRASS]: { name: "Grama", color: COLORS[B_GRASS] },
    [B_STONE]: { name: "Pedra", color: COLORS[B_STONE] },
    [B_WOOD]: { name: "Madeira", color: COLORS[B_WOOD] },
    [B_LOG]: { name: "Tronco", color: COLORS[B_LOG] },
    [B_COAL]: { name: "Carv√£o", color: COLORS[B_COAL], icon: "‚ö´" },
    [B_IRON]: { name: "Ferro", color: COLORS[B_IRON], icon: "‚ö™" },
    [B_GOLD]: { name: "Ouro", color: COLORS[B_GOLD], icon: "üü°" },
    [B_DIAMOND]: { name: "Diamante", color: COLORS[B_DIAMOND], icon: "üíé" },
    [B_HELLSTONE]: { name: "Rocha Infernal", color: COLORS[B_HELLSTONE] },
    [B_BRICK]: { name: "Tijolo", color: COLORS[B_BRICK] },
    [B_PORTAL_NETHER]: { name: "Portal Nether", color: COLORS[B_PORTAL_NETHER], icon: "üî•" },
    [B_PLANKS]: { name: "T√°buas", color: COLORS[B_PLANKS] },
    [B_TORCH]: { name: "Tocha", color: COLORS[B_TORCH], icon: "üî•" },
    [B_FLOWER]: { name: "Flor", color: COLORS[B_FLOWER], icon: "üå∑" },
    [B_TALLGRASS]: { name: "Mato", color: COLORS[B_TALLGRASS], icon: "üåø" },
    [B_COPPER]: { name: "Cobre", color: COLORS[B_COPPER], icon: "üü†" },
    [B_AMETHYST]: { name: "Ametista", color: COLORS[B_AMETHYST], icon: "üîÆ" },
    [B_SAND]: { name: "Areia", color: COLORS[B_SAND] },
    [B_WATER]: { name: "√Ågua", color: COLORS[B_WATER], icon: "üíß" },
    [B_EMERALD]: { name: "Esmeralda", color: COLORS[B_EMERALD], icon: "üíö" },
    [B_RUBY]: { name: "Rubi", color: COLORS[B_RUBY], icon: "‚ù§Ô∏è" },
    [B_TITANIUM]: { name: "Tit√¢nio", color: COLORS[B_TITANIUM], icon: "üî©" },
    [B_GLOWSTONE]: { name: "Pedra Luminosa", color: COLORS[B_GLOWSTONE], icon: "üí°" },
    [B_SNOW]: { name: "Neve", color: COLORS[B_SNOW], icon: "‚ùÑÔ∏è" },
    [B_IRON_BARS]: { name: "Grades", color: COLORS[B_IRON_BARS], icon: "‚õìÔ∏è" },
    [B_PORTAL_AETHER]: { name: "Portal Aether", color: COLORS[B_PORTAL_AETHER], icon: "‚òÅÔ∏è" },
    [B_PORTAL_PRISON]: { name: "Portal Pris√£o", color: COLORS[B_PORTAL_PRISON], icon: "üóùÔ∏è" },
    [B_PORTAL_EVEREST]: { name: "Portal Everest", color: COLORS[B_PORTAL_EVEREST], icon: "üèîÔ∏è" },
    [B_REDSTONE]: { name: "Redstone", color: COLORS[B_REDSTONE], icon: "üõë" },
    
    [ITEM_BACON]: { name: "Bacon", color: "#f06292", icon: "ü•ì" },
    [ITEM_STEAK]: { name: "Bife", color: "#8d6e63", icon: "ü•©" },
    [ITEM_WOOL]: { name: "L√£", color: "#eeeeee", icon: "‚òÅÔ∏è" },
    [ITEM_CHICKEN_RAW]: { name: "Frango Cru", color: "#ffebee", icon: "üçó" },
    [ITEM_STRING]: { name: "Teia", color: "#fff", icon: "üï∏Ô∏è" },
    [ITEM_MAGIC_STAFF]: { name: "Cajado M√°gico", color: "#b0f", icon: "ü™Ñ" },

    // Existing Tools
    [ITEM_WOOD_PICKAXE]: { name: "Picareta Madeira", color: "#8d6e63", icon: "‚õèÔ∏è" },
    [ITEM_WOOD_SWORD]: { name: "Espada Madeira", color: "#8d6e63", icon: "‚öîÔ∏è" },
    [ITEM_STONE_PICKAXE]: { name: "Picareta Pedra", color: "#757575", icon: "‚õèÔ∏è" },
    [ITEM_STONE_SWORD]: { name: "Espada Pedra", color: "#757575", icon: "‚öîÔ∏è" },
    [ITEM_COPPER_PICKAXE]: { name: "Picareta Cobre", color: "#e67e22", icon: "‚õèÔ∏è" },
    [ITEM_COPPER_SWORD]: { name: "Espada Cobre", color: "#e67e22", icon: "‚öîÔ∏è" },
    [ITEM_IRON_PICKAXE]: { name: "Picareta Ferro", color: "#d7ccc8", icon: "‚õèÔ∏è" },
    [ITEM_IRON_SWORD]: { name: "Espada Ferro", color: "#d7ccc8", icon: "‚öîÔ∏è" },
    [ITEM_AMETHYST_PICKAXE]: { name: "Picareta Ametista", color: "#9b59b6", icon: "‚õèÔ∏è" },
    [ITEM_AMETHYST_SWORD]: { name: "Espada Ametista", color: "#9b59b6", icon: "‚öîÔ∏è" },
    [ITEM_EMERALD_PICKAXE]: { name: "Picareta Esmeralda", color: "#00e676", icon: "‚õèÔ∏è" },
    [ITEM_EMERALD_SWORD]: { name: "Espada Esmeralda", color: "#00e676", icon: "‚öîÔ∏è" },
    [ITEM_RUBY_PICKAXE]: { name: "Picareta Rubi", color: "#d50000", icon: "‚õèÔ∏è" },
    [ITEM_RUBY_SWORD]: { name: "Espada Rubi", color: "#d50000", icon: "‚öîÔ∏è" },
    [ITEM_DIAMOND_PICKAXE]: { name: "Picareta Diamante", color: "#00e5ff", icon: "‚õèÔ∏è" },
    [ITEM_DIAMOND_SWORD]: { name: "Espada Diamante", color: "#00e5ff", icon: "‚öîÔ∏è" },
    [ITEM_TITANIUM_PICKAXE]: { name: "Picareta Tit√¢nio", color: "#90a4ae", icon: "‚õèÔ∏è" },
    [ITEM_TITANIUM_SWORD]: { name: "Espada Tit√¢nio", color: "#90a4ae", icon: "‚öîÔ∏è" },
    [ITEM_SURREAL_PICKAXE]: { name: "Picareta SURREAL", color: "#ff4081", icon: "‚õèÔ∏è" },
    [ITEM_SURREAL_SWORD]: { name: "Espada SURREAL", color: "#ff4081", icon: "‚öîÔ∏è" },

    // New Tools
    // Axes
    [ITEM_WOOD_AXE]: { name: "Machado Madeira", color: "#8d6e63", icon: "ü™ì" },
    [ITEM_STONE_AXE]: { name: "Machado Pedra", color: "#757575", icon: "ü™ì" },
    [ITEM_COPPER_AXE]: { name: "Machado Cobre", color: "#e67e22", icon: "ü™ì" },
    [ITEM_IRON_AXE]: { name: "Machado Ferro", color: "#d7ccc8", icon: "ü™ì" },
    [ITEM_AMETHYST_AXE]: { name: "Machado Ametista", color: "#9b59b6", icon: "ü™ì" },
    [ITEM_EMERALD_AXE]: { name: "Machado Esmeralda", color: "#00e676", icon: "ü™ì" },
    [ITEM_RUBY_AXE]: { name: "Machado Rubi", color: "#d50000", icon: "ü™ì" },
    [ITEM_DIAMOND_AXE]: { name: "Machado Diamante", color: "#00e5ff", icon: "ü™ì" },
    [ITEM_TITANIUM_AXE]: { name: "Machado Tit√¢nio", color: "#90a4ae", icon: "ü™ì" },
    [ITEM_SURREAL_AXE]: { name: "Machado SURREAL", color: "#ff4081", icon: "ü™ì" },
    
    // Sickles
    [ITEM_WOOD_SICKLE]: { name: "Foice Madeira", color: "#8d6e63", icon: "üåô" },
    [ITEM_STONE_SICKLE]: { name: "Foice Pedra", color: "#757575", icon: "üåô" },
    [ITEM_COPPER_SICKLE]: { name: "Foice Cobre", color: "#e67e22", icon: "üåô" },
    [ITEM_IRON_SICKLE]: { name: "Foice Ferro", color: "#d7ccc8", icon: "üåô" },
    [ITEM_AMETHYST_SICKLE]: { name: "Foice Ametista", color: "#9b59b6", icon: "üåô" },
    [ITEM_EMERALD_SICKLE]: { name: "Foice Esmeralda", color: "#00e676", icon: "üåô" },
    [ITEM_RUBY_SICKLE]: { name: "Foice Rubi", color: "#d50000", icon: "üåô" },
    [ITEM_DIAMOND_SICKLE]: { name: "Foice Diamante", color: "#00e5ff", icon: "üåô" },
    [ITEM_TITANIUM_SICKLE]: { name: "Foice Tit√¢nio", color: "#90a4ae", icon: "üåô" },
    [ITEM_SURREAL_SICKLE]: { name: "Foice SURREAL", color: "#ff4081", icon: "üåô" },

    // Knives
    [ITEM_WOOD_KNIFE]: { name: "Faca Madeira", color: "#8d6e63", icon: "üî™" },
    [ITEM_STONE_KNIFE]: { name: "Faca Pedra", color: "#757575", icon: "üî™" },
    [ITEM_COPPER_KNIFE]: { name: "Faca Cobre", color: "#e67e22", icon: "üî™" },
    [ITEM_IRON_KNIFE]: { name: "Faca Ferro", color: "#d7ccc8", icon: "üî™" },
    [ITEM_AMETHYST_KNIFE]: { name: "Faca Ametista", color: "#9b59b6", icon: "üî™" },
    [ITEM_EMERALD_KNIFE]: { name: "Faca Esmeralda", color: "#00e676", icon: "üî™" },
    [ITEM_RUBY_KNIFE]: { name: "Faca Rubi", color: "#d50000", icon: "üî™" },
    [ITEM_DIAMOND_KNIFE]: { name: "Faca Diamante", color: "#00e5ff", icon: "üî™" },
    [ITEM_TITANIUM_KNIFE]: { name: "Faca Tit√¢nio", color: "#90a4ae", icon: "üî™" },
    [ITEM_SURREAL_KNIFE]: { name: "Faca SURREAL", color: "#ff4081", icon: "üî™" },

    // --- ARMOR DEFINITIONS ---
    // armorType: 0=Head, 1=Body, 2=Legs, 3=Feet
    [ARMOR_STONE_HELM]: { name: "Capacete Pedra", color: "#757575", icon: "ü™ñ", defense: 2, armorType: 0 },
    [ARMOR_STONE_CHEST]: { name: "Peitoral Pedra", color: "#757575", icon: "üëï", defense: 3, armorType: 1 },
    [ARMOR_STONE_LEGS]: { name: "Cal√ßa Pedra", color: "#757575", icon: "üëñ", defense: 2, armorType: 2 },
    [ARMOR_STONE_BOOTS]: { name: "Botas Pedra", color: "#757575", icon: "üë¢", defense: 1, armorType: 3 },

    [ARMOR_COPPER_HELM]: { name: "Capacete Cobre", color: "#e67e22", icon: "ü™ñ", defense: 3, armorType: 0 },
    [ARMOR_COPPER_CHEST]: { name: "Peitoral Cobre", color: "#e67e22", icon: "üëï", defense: 4, armorType: 1 },
    [ARMOR_COPPER_LEGS]: { name: "Cal√ßa Cobre", color: "#e67e22", icon: "üëñ", defense: 3, armorType: 2 },
    [ARMOR_COPPER_BOOTS]: { name: "Botas Cobre", color: "#e67e22", icon: "üë¢", defense: 2, armorType: 3 },

    [ARMOR_IRON_HELM]: { name: "Capacete Ferro", color: "#d7ccc8", icon: "ü™ñ", defense: 4, armorType: 0 },
    [ARMOR_IRON_CHEST]: { name: "Peitoral Ferro", color: "#d7ccc8", icon: "üëï", defense: 6, armorType: 1 },
    [ARMOR_IRON_LEGS]: { name: "Cal√ßa Ferro", color: "#d7ccc8", icon: "üëñ", defense: 5, armorType: 2 },
    [ARMOR_IRON_BOOTS]: { name: "Botas Ferro", color: "#d7ccc8", icon: "üë¢", defense: 2, armorType: 3 },

    [ARMOR_AMETHYST_HELM]: { name: "Capacete Ametista", color: "#9b59b6", icon: "ü™ñ", defense: 5, armorType: 0 },
    [ARMOR_AMETHYST_CHEST]: { name: "Peitoral Ametista", color: "#9b59b6", icon: "üëï", defense: 7, armorType: 1 },
    [ARMOR_AMETHYST_LEGS]: { name: "Cal√ßa Ametista", color: "#9b59b6", icon: "üëñ", defense: 6, armorType: 2 },
    [ARMOR_AMETHYST_BOOTS]: { name: "Botas Ametista", color: "#9b59b6", icon: "üë¢", defense: 3, armorType: 3 },

    [ARMOR_REDSTONE_HELM]: { name: "Capacete Redstone", color: "#ff1744", icon: "ü™ñ", defense: 4, armorType: 0 },
    [ARMOR_REDSTONE_CHEST]: { name: "Peitoral Redstone", color: "#ff1744", icon: "üëï", defense: 5, armorType: 1 }, // Habilidade: Pulo Alto
    [ARMOR_REDSTONE_LEGS]: { name: "Cal√ßa Redstone", color: "#ff1744", icon: "üëñ", defense: 4, armorType: 2 },
    [ARMOR_REDSTONE_BOOTS]: { name: "Botas Redstone", color: "#ff1744", icon: "üë¢", defense: 2, armorType: 3 }, // Habilidade: Velocidade

    [ARMOR_DIAMOND_HELM]: { name: "Capacete Diamante", color: "#00e5ff", icon: "ü™ñ", defense: 6, armorType: 0 },
    [ARMOR_DIAMOND_CHEST]: { name: "Peitoral Diamante", color: "#00e5ff", icon: "üëï", defense: 9, armorType: 1 },
    [ARMOR_DIAMOND_LEGS]: { name: "Cal√ßa Diamante", color: "#00e5ff", icon: "üëñ", defense: 7, armorType: 2 },
    [ARMOR_DIAMOND_BOOTS]: { name: "Botas Diamante", color: "#00e5ff", icon: "üë¢", defense: 4, armorType: 3 },

    [ARMOR_SURREAL_HELM]: { name: "Capacete SURREAL", color: "#ff4081", icon: "ü™ñ", defense: 10, armorType: 0 },
    [ARMOR_SURREAL_CHEST]: { name: "Peitoral SURREAL", color: "#ff4081", icon: "üëï", defense: 15, armorType: 1 },
    [ARMOR_SURREAL_LEGS]: { name: "Cal√ßa SURREAL", color: "#ff4081", icon: "üëñ", defense: 12, armorType: 2 },
    [ARMOR_SURREAL_BOOTS]: { name: "Botas SURREAL", color: "#ff4081", icon: "üë¢", defense: 8, armorType: 3 }
};

const RECIPES = [
    { out: B_PLANKS, count: 4, cost: [{id: B_LOG, n: 1}] },
    { out: B_TORCH, count: 4, cost: [{id: B_LOG, n: 1}, {id: B_COAL, n: 1}] },
    { out: B_TORCH, count: 2, cost: [{id: B_WOOD, n: 1}, {id: B_COAL, n: 1}] },
    { out: B_GLOWSTONE, count: 1, cost: [{id: B_GOLD, n: 1}, {id: B_TORCH, n: 1}] },
    { out: B_IRON_BARS, count: 4, cost: [{id: B_IRON, n: 2}] },
    { out: B_SNOW, count: 4, cost: [{id: B_WATER, n: 1}] },
    
    // Tools
    { out: ITEM_WOOD_PICKAXE, count: 1, cost: [{id: B_LOG, n: 3}] },
    { out: ITEM_WOOD_SWORD, count: 1, cost: [{id: B_LOG, n: 2}] },
    { out: ITEM_STONE_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_STONE, n: 3}] },
    { out: ITEM_STONE_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_STONE, n: 2}] },
    { out: ITEM_COPPER_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_COPPER, n: 3}] },
    { out: ITEM_COPPER_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_COPPER, n: 2}] },
    { out: ITEM_IRON_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_IRON, n: 3}] },
    { out: ITEM_IRON_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_IRON, n: 2}] },
    { out: ITEM_AMETHYST_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_AMETHYST, n: 3}] },
    { out: ITEM_AMETHYST_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_AMETHYST, n: 2}] },
    { out: ITEM_EMERALD_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_EMERALD, n: 3}] },
    { out: ITEM_EMERALD_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_EMERALD, n: 2}] },
    { out: ITEM_RUBY_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_RUBY, n: 3}] },
    { out: ITEM_RUBY_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_RUBY, n: 2}] },
    { out: ITEM_DIAMOND_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_DIAMOND, n: 3}] },
    { out: ITEM_DIAMOND_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_DIAMOND, n: 2}] },
    { out: ITEM_TITANIUM_PICKAXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_TITANIUM, n: 3}] },
    { out: ITEM_TITANIUM_SWORD, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_TITANIUM, n: 2}] },
    { out: ITEM_SURREAL_PICKAXE, count: 1, cost: [{id: B_HELLSTONE, n: 5}, {id: B_DIAMOND, n: 3}] },
    { out: ITEM_SURREAL_SWORD, count: 1, cost: [{id: B_HELLSTONE, n: 10}, {id: B_DIAMOND, n: 5}] },

    // New Tool Recipes
    // Axes
    { out: ITEM_WOOD_AXE, count: 1, cost: [{id: B_LOG, n: 3}] },
    { out: ITEM_STONE_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_STONE, n: 3}] },
    { out: ITEM_COPPER_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_COPPER, n: 3}] },
    { out: ITEM_IRON_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_IRON, n: 3}] },
    { out: ITEM_AMETHYST_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_AMETHYST, n: 3}] },
    { out: ITEM_EMERALD_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_EMERALD, n: 3}] },
    { out: ITEM_RUBY_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_RUBY, n: 3}] },
    { out: ITEM_DIAMOND_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_DIAMOND, n: 3}] },
    { out: ITEM_TITANIUM_AXE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_TITANIUM, n: 3}] },
    { out: ITEM_SURREAL_AXE, count: 1, cost: [{id: B_HELLSTONE, n: 5}, {id: B_DIAMOND, n: 3}] },
    // Sickles
    { out: ITEM_WOOD_SICKLE, count: 1, cost: [{id: B_LOG, n: 3}] },
    { out: ITEM_STONE_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_STONE, n: 3}] },
    { out: ITEM_COPPER_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_COPPER, n: 3}] },
    { out: ITEM_IRON_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_IRON, n: 3}] },
    { out: ITEM_AMETHYST_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_AMETHYST, n: 3}] },
    { out: ITEM_EMERALD_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_EMERALD, n: 3}] },
    { out: ITEM_RUBY_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_RUBY, n: 3}] },
    { out: ITEM_DIAMOND_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_DIAMOND, n: 3}] },
    { out: ITEM_TITANIUM_SICKLE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_TITANIUM, n: 3}] },
    { out: ITEM_SURREAL_SICKLE, count: 1, cost: [{id: B_HELLSTONE, n: 5}, {id: B_DIAMOND, n: 3}] },
    // Knives
    { out: ITEM_WOOD_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}] },
    { out: ITEM_STONE_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_STONE, n: 1}] },
    { out: ITEM_COPPER_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_COPPER, n: 1}] },
    { out: ITEM_IRON_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_IRON, n: 1}] },
    { out: ITEM_AMETHYST_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_AMETHYST, n: 1}] },
    { out: ITEM_EMERALD_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_EMERALD, n: 1}] },
    { out: ITEM_RUBY_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_RUBY, n: 1}] },
    { out: ITEM_DIAMOND_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_DIAMOND, n: 1}] },
    { out: ITEM_TITANIUM_KNIFE, count: 1, cost: [{id: B_LOG, n: 1}, {id: B_TITANIUM, n: 1}] },
    { out: ITEM_SURREAL_KNIFE, count: 1, cost: [{id: B_HELLSTONE, n: 2}, {id: B_DIAMOND, n: 1}] },
    
    // --- ARMOR RECIPES ---
    // Stone
    { out: ARMOR_STONE_HELM, count: 1, cost: [{id: B_STONE, n: 5}] },
    { out: ARMOR_STONE_CHEST, count: 1, cost: [{id: B_STONE, n: 8}] },
    { out: ARMOR_STONE_LEGS, count: 1, cost: [{id: B_STONE, n: 7}] },
    { out: ARMOR_STONE_BOOTS, count: 1, cost: [{id: B_STONE, n: 4}] },
    // Copper
    { out: ARMOR_COPPER_HELM, count: 1, cost: [{id: B_COPPER, n: 5}] },
    { out: ARMOR_COPPER_CHEST, count: 1, cost: [{id: B_COPPER, n: 8}] },
    { out: ARMOR_COPPER_LEGS, count: 1, cost: [{id: B_COPPER, n: 7}] },
    { out: ARMOR_COPPER_BOOTS, count: 1, cost: [{id: B_COPPER, n: 4}] },
    // Iron
    { out: ARMOR_IRON_HELM, count: 1, cost: [{id: B_IRON, n: 5}] },
    { out: ARMOR_IRON_CHEST, count: 1, cost: [{id: B_IRON, n: 8}] },
    { out: ARMOR_IRON_LEGS, count: 1, cost: [{id: B_IRON, n: 7}] },
    { out: ARMOR_IRON_BOOTS, count: 1, cost: [{id: B_IRON, n: 4}] },
    // Amethyst
    { out: ARMOR_AMETHYST_HELM, count: 1, cost: [{id: B_AMETHYST, n: 5}] },
    { out: ARMOR_AMETHYST_CHEST, count: 1, cost: [{id: B_AMETHYST, n: 8}] },
    { out: ARMOR_AMETHYST_LEGS, count: 1, cost: [{id: B_AMETHYST, n: 7}] },
    { out: ARMOR_AMETHYST_BOOTS, count: 1, cost: [{id: B_AMETHYST, n: 4}] },
    // Redstone (Habilidade)
    { out: ARMOR_REDSTONE_HELM, count: 1, cost: [{id: B_REDSTONE, n: 5}] },
    { out: ARMOR_REDSTONE_CHEST, count: 1, cost: [{id: B_REDSTONE, n: 8}] },
    { out: ARMOR_REDSTONE_LEGS, count: 1, cost: [{id: B_REDSTONE, n: 7}] },
    { out: ARMOR_REDSTONE_BOOTS, count: 1, cost: [{id: B_REDSTONE, n: 4}] },
    // Diamond
    { out: ARMOR_DIAMOND_HELM, count: 1, cost: [{id: B_DIAMOND, n: 5}] },
    { out: ARMOR_DIAMOND_CHEST, count: 1, cost: [{id: B_DIAMOND, n: 8}] },
    { out: ARMOR_DIAMOND_LEGS, count: 1, cost: [{id: B_DIAMOND, n: 7}] },
    { out: ARMOR_DIAMOND_BOOTS, count: 1, cost: [{id: B_DIAMOND, n: 4}] },
    // Surreal (Uses Hellstone + Diamond as base like pickaxe logic)
    { out: ARMOR_SURREAL_HELM, count: 1, cost: [{id: B_HELLSTONE, n: 5}, {id: B_DIAMOND, n: 2}] },
    { out: ARMOR_SURREAL_CHEST, count: 1, cost: [{id: B_HELLSTONE, n: 8}, {id: B_DIAMOND, n: 4}] },
    { out: ARMOR_SURREAL_LEGS, count: 1, cost: [{id: B_HELLSTONE, n: 7}, {id: B_DIAMOND, n: 3}] },
    { out: ARMOR_SURREAL_BOOTS, count: 1, cost: [{id: B_HELLSTONE, n: 4}, {id: B_DIAMOND, n: 2}] },

    // Portals
    { out: B_PORTAL_NETHER, count: 1, cost: [{id: B_HELLSTONE, n: 10}] },
    { out: B_PORTAL_AETHER, count: 1, cost: [{id: B_GLOWSTONE, n: 10}] },
    { out: B_PORTAL_PRISON, count: 1, cost: [{id: B_IRON_BARS, n: 10}] },
    { out: B_PORTAL_EVEREST, count: 1, cost: [{id: B_SNOW, n: 10}] },
    
    { out: B_BRICK, count: 4, cost: [{id: B_STONE, n: 1}] },
    { out: ITEM_MAGIC_STAFF, count: 1, cost: [{id: B_DIAMOND, n: 2}, {id: B_AMETHYST, n: 2}] }
];

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const HOTBAR_SIZE = 9;
const TOTAL_INV_SIZE = 36;

let gameState = {
    chunks: {}, generatedChunks: new Set(),
    camera: { x: 0, y: 0 },
    player: null, entities: [], droppedItems: [], projectiles: [], particles: [],
    time: 6000, dayCount: 1, isMenu: true,
    isInventoryOpen: false, cursorItem: null,
    dimension: 'overworld'
};

let input = { left: false, right: false, up: false, down: false, click: false, rightClick: false, mouseX: 0, mouseY: 0, keys: {} };

function getToolStats(id) {
    if (!id) return { power: 1, damage: 1, type: 'none', cooldown: 20 };
    
    let base = { power: 1, damage: 1, type: 'none', cooldown: 20 };

    // Standard Tools
    if (id === ITEM_WOOD_PICKAXE) base = { power: 2, damage: 3, type: 'pickaxe', cooldown: 20 };
    if (id === ITEM_WOOD_SWORD) base = { power: 1, damage: 6, type: 'sword', cooldown: 20 };
    if (id === ITEM_STONE_PICKAXE) base = { power: 3, damage: 4, type: 'pickaxe', cooldown: 20 };
    if (id === ITEM_STONE_SWORD) base = { power: 1, damage: 10, type: 'sword', cooldown: 20 };
    if (id === ITEM_COPPER_PICKAXE) base = { power: 4, damage: 5, type: 'pickaxe', cooldown: 18 };
    if (id === ITEM_COPPER_SWORD) base = { power: 1, damage: 12, type: 'sword', cooldown: 20 };
    if (id === ITEM_IRON_PICKAXE) base = { power: 5, damage: 6, type: 'pickaxe', cooldown: 18 };
    if (id === ITEM_IRON_SWORD) base = { power: 1, damage: 15, type: 'sword', cooldown: 20 };
    if (id === ITEM_AMETHYST_PICKAXE) base = { power: 7, damage: 8, type: 'pickaxe', cooldown: 15 };
    if (id === ITEM_AMETHYST_SWORD) base = { power: 1, damage: 20, type: 'sword', cooldown: 20 };
    if (id === ITEM_EMERALD_PICKAXE) base = { power: 8, damage: 9, type: 'pickaxe', cooldown: 15 };
    if (id === ITEM_EMERALD_SWORD) base = { power: 1, damage: 22, type: 'sword', cooldown: 20 };
    if (id === ITEM_RUBY_PICKAXE) base = { power: 9, damage: 12, type: 'pickaxe', cooldown: 12 };
    if (id === ITEM_RUBY_SWORD) base = { power: 1, damage: 28, type: 'sword', cooldown: 20 };
    if (id === ITEM_DIAMOND_PICKAXE) base = { power: 10, damage: 10, type: 'pickaxe', cooldown: 12 };
    if (id === ITEM_DIAMOND_SWORD) base = { power: 1, damage: 30, type: 'sword', cooldown: 20 };
    if (id === ITEM_TITANIUM_PICKAXE) base = { power: 15, damage: 12, type: 'pickaxe', cooldown: 10 };
    if (id === ITEM_TITANIUM_SWORD) base = { power: 1, damage: 40, type: 'sword', cooldown: 20 };
    if (id === ITEM_SURREAL_PICKAXE) base = { power: 20, damage: 15, type: 'pickaxe', cooldown: 8 };
    if (id === ITEM_SURREAL_SWORD) base = { power: 1, damage: 50, type: 'sword', cooldown: 18 };
    
    // Axes (High Damage, Slow Cooldown, High Wood Power)
    if (id === ITEM_WOOD_AXE) base = { power: 2, damage: 9, type: 'axe', cooldown: 35 };
    if (id === ITEM_STONE_AXE) base = { power: 3, damage: 15, type: 'axe', cooldown: 35 };
    if (id === ITEM_COPPER_AXE) base = { power: 4, damage: 18, type: 'axe', cooldown: 35 };
    if (id === ITEM_IRON_AXE) base = { power: 5, damage: 22, type: 'axe', cooldown: 35 };
    if (id === ITEM_AMETHYST_AXE) base = { power: 7, damage: 30, type: 'axe', cooldown: 30 };
    if (id === ITEM_EMERALD_AXE) base = { power: 8, damage: 33, type: 'axe', cooldown: 30 };
    if (id === ITEM_RUBY_AXE) base = { power: 9, damage: 42, type: 'axe', cooldown: 30 };
    if (id === ITEM_DIAMOND_AXE) base = { power: 10, damage: 45, type: 'axe', cooldown: 30 };
    if (id === ITEM_TITANIUM_AXE) base = { power: 15, damage: 60, type: 'axe', cooldown: 30 };
    if (id === ITEM_SURREAL_AXE) base = { power: 20, damage: 75, type: 'axe', cooldown: 25 };

    // Sickles (Combat Focused: Higher Damage than Sword, Normal Cooldown)
    if (id === ITEM_WOOD_SICKLE) base = { power: 1, damage: 7, type: 'sickle', cooldown: 22 };
    if (id === ITEM_STONE_SICKLE) base = { power: 1, damage: 12, type: 'sickle', cooldown: 22 };
    if (id === ITEM_COPPER_SICKLE) base = { power: 1, damage: 15, type: 'sickle', cooldown: 22 };
    if (id === ITEM_IRON_SICKLE) base = { power: 1, damage: 19, type: 'sickle', cooldown: 22 };
    if (id === ITEM_AMETHYST_SICKLE) base = { power: 1, damage: 25, type: 'sickle', cooldown: 20 };
    if (id === ITEM_EMERALD_SICKLE) base = { power: 1, damage: 28, type: 'sickle', cooldown: 20 };
    if (id === ITEM_RUBY_SICKLE) base = { power: 1, damage: 35, type: 'sickle', cooldown: 20 };
    if (id === ITEM_DIAMOND_SICKLE) base = { power: 1, damage: 38, type: 'sickle', cooldown: 20 };
    if (id === ITEM_TITANIUM_SICKLE) base = { power: 1, damage: 50, type: 'sickle', cooldown: 20 };
    if (id === ITEM_SURREAL_SICKLE) base = { power: 1, damage: 65, type: 'sickle', cooldown: 18 };

    // Knives (Low Damage, Very Fast Cooldown)
    if (id === ITEM_WOOD_KNIFE) base = { power: 1, damage: 3, type: 'knife', cooldown: 10 };
    if (id === ITEM_STONE_KNIFE) base = { power: 1, damage: 5, type: 'knife', cooldown: 10 };
    if (id === ITEM_COPPER_KNIFE) base = { power: 1, damage: 6, type: 'knife', cooldown: 10 };
    if (id === ITEM_IRON_KNIFE) base = { power: 1, damage: 7, type: 'knife', cooldown: 10 };
    if (id === ITEM_AMETHYST_KNIFE) base = { power: 1, damage: 10, type: 'knife', cooldown: 8 };
    if (id === ITEM_EMERALD_KNIFE) base = { power: 1, damage: 11, type: 'knife', cooldown: 8 };
    if (id === ITEM_RUBY_KNIFE) base = { power: 1, damage: 14, type: 'knife', cooldown: 8 };
    if (id === ITEM_DIAMOND_KNIFE) base = { power: 1, damage: 15, type: 'knife', cooldown: 8 };
    if (id === ITEM_TITANIUM_KNIFE) base = { power: 1, damage: 20, type: 'knife', cooldown: 8 };
    if (id === ITEM_SURREAL_KNIFE) base = { power: 1, damage: 25, type: 'knife', cooldown: 6 };

    if (id === ITEM_MAGIC_STAFF) base = { power: 1, damage: 25, type: 'staff', cooldown: 30 };

    return base;
}

class Entity {
    constructor(x, y, w, h, color, type) {
        this.x = x; this.y = y; this.w = w; this.h = h;
        this.vx = 0; this.vy = 0; this.color = color; this.type = type;
        this.grounded = false; this.inWater = false;
        
        if (type === 'player') this.health = 100;
        else if (type === 'villager') this.health = 50;
        else if (type === 'zombie') this.health = 30;
        else if (type === 'skeleton') this.health = 25;
        else if (type === 'slime') this.health = 15;
        else if (type === 'pig') this.health = 10;
        else if (type === 'cow') this.health = 20;
        else if (type === 'sheep') this.health = 10;
        else if (type === 'chicken') this.health = 5;
        else if (type === 'spider') this.health = 20;
        else if (type === 'robot') this.health = 40;
        else if (type === 'ore_golem_coal') this.health = 60;
        else if (type === 'ore_golem_gold') this.health = 80;
        else if (type === 'ore_beast_amethyst') this.health = 50;
        
        this.maxHealth = this.health;
        this.facingRight = true; this.invincible = 0;
        this.animTimer = 0; this.walkFrame = 0;
        this.miningState = { active: false, x: 0, y: 0, progress: 0 };
    }
    update() {
        this.animTimer++;
        this.vy += GRAVITY;
        
        let cx = Math.floor((this.x+this.w/2)/BLOCK_SIZE);
        let cy = Math.floor((this.y+this.h/2)/BLOCK_SIZE);
        this.inWater = getBlock(cx, cy) === B_WATER;
        
        if (this.inWater) {
            this.vy *= 0.8; 
            if(this.vy > 3) this.vy = 3; 
        } else {
            if (this.vy > TERMINAL_VELOCITY) this.vy = TERMINAL_VELOCITY;
        }

        if (this.type !== 'player') this.updateAI();

        this.x += this.vx; this.handleCollisions(true);
        this.y += this.vy; this.grounded = false; this.handleCollisions(false);

        if (this.grounded) this.vx *= 0.8; else this.vx *= 0.95;
        if (Math.abs(this.vx) < 0.1) this.vx = 0;
        if (Math.abs(this.vx) > 0.1) this.walkFrame = Math.sin(this.animTimer * 0.15); else this.walkFrame = 0;

        if (this.invincible > 0) this.invincible--;
        if (this.y > CHUNK_HEIGHT * BLOCK_SIZE + 200) this.takeDamage(999);
    }
    updateAI() {
        if(this.type === 'player' || this.type === 'npc') return;
        let p = gameState.player;
        let dist = Math.abs(p.x - this.x);
        let dy = Math.abs(p.y - this.y);
        
        // Passive Mobs
        if (['pig', 'cow', 'sheep', 'chicken'].includes(this.type)) {
            if (this.grounded && Math.random() < 0.01) { 
                this.vx = (Math.random() - 0.5) * 2; this.facingRight = this.vx > 0; 
            }
            let wallX = this.x + (this.vx>0 ? this.w+5 : -5);
            let wallBx = Math.floor(wallX/BLOCK_SIZE);
            let wallBy = Math.floor((this.y + this.h - 5)/BLOCK_SIZE);
            let b = getBlock(wallBx, wallBy);
            if(this.grounded && b !== B_AIR && b !== B_WATER && b !== B_FLOWER && b !== B_TALLGRASS && b !== B_TORCH) { this.vy = -5; }
            return;
        }

        // Hostile Mobs
        if(dist < 300) {
            let speed = 0.2;
            if (this.type === 'spider') speed = 0.4;
            if (this.type === 'ore_golem_coal' || this.type === 'ore_golem_gold') speed = 0.1;

            if(p.x > this.x) this.vx += speed; else this.vx -= speed;
            this.facingRight = this.vx > 0;

            let wallX = this.x + (this.vx>0 ? this.w+5 : -5);
            if(this.grounded && getBlock(Math.floor(wallX/BLOCK_SIZE), Math.floor(this.y/BLOCK_SIZE)) !== B_AIR) {
                if(this.type === 'spider') this.vy = -7; // Spiders jump higher
                else this.vy = -6;
            }
        }
        
        // Attack
        if(checkRectOverlap(this, p) && Math.random()<0.05) {
            let dmg = 5;
            if (this.type === 'robot') dmg = 10;
            if (this.type === 'ore_golem_gold') dmg = 15;
            if (this.type === 'spider') dmg = 8;
            p.takeDamage(dmg);
        }
    }
    handleCollisions(horizontal) {
        let startX = Math.floor(this.x / BLOCK_SIZE); let endX = Math.floor((this.x + this.w) / BLOCK_SIZE);
        let startY = Math.floor(this.y / BLOCK_SIZE); let endY = Math.floor((this.y + this.h) / BLOCK_SIZE);
        for (let y = startY; y <= endY; y++) {
            for (let x = startX; x <= endX; x++) {
                let block = getBlock(x, y);
                if (block === B_PORTAL_NETHER || block === B_PORTAL_AETHER || block === B_PORTAL_PRISON || block === B_PORTAL_EVEREST) {
                    if (this.type === 'player') switchDimension(block);
                }
                if (block && block !== B_AIR && block !== B_PORTAL_NETHER && block !== B_PORTAL_AETHER && block !== B_PORTAL_PRISON && block !== B_PORTAL_EVEREST && block !== B_TORCH && block !== B_FLOWER && block !== B_TALLGRASS && block !== B_WATER) {
                    if (horizontal) {
                        if (this.vx > 0) this.x = x * BLOCK_SIZE - this.w - 0.01;
                        if (this.vx < 0) this.x = (x + 1) * BLOCK_SIZE + 0.01;
                        this.vx = 0;
                    } else {
                        if (this.vy > 0) { this.y = y * BLOCK_SIZE - this.h - 0.01; this.grounded = true; }
                        if (this.vy < 0) this.y = (y + 1) * BLOCK_SIZE + 0.01;
                        this.vy = 0;
                    }
                    return;
                }
            }
        }
    }
    takeDamage(n) { 
        if(this.invincible>0) return; 
        
        // Armor Logic
        if (this.type === 'player') {
            let totalDef = 0;
            this.armor.forEach(item => { if(item && ITEM_DATA[item.id].defense) totalDef += ITEM_DATA[item.id].defense; });
            let reduction = Math.min(0.8, totalDef * 0.02); // Max 80% reduction
            n = Math.ceil(n * (1 - reduction));
            if (n < 1) n = 1; // Min damage
        }

        this.health-=n; this.invincible=20; this.vy=-4; this.vx=this.x<gameState.player.x?-3:3; 
        if(this.health<=0) { 
            if(this.type==='player') respawnPlayer(); 
            else { 
                this.dead=true; 
                // Drops
                if(this.type==='pig') dropItem(this.x,this.y,ITEM_BACON,1); 
                if(this.type==='cow') dropItem(this.x,this.y,ITEM_STEAK,1); 
                if(this.type==='sheep') dropItem(this.x,this.y,ITEM_WOOL,1);
                if(this.type==='chicken') dropItem(this.x,this.y,ITEM_CHICKEN_RAW,1);
                if(this.type==='spider') dropItem(this.x,this.y,ITEM_STRING,1);
                if(this.type==='robot') {
                    if(Math.random()>0.5) dropItem(this.x,this.y,B_IRON,1);
                    else dropItem(this.x,this.y,B_REDSTONE,1);
                }
                if(this.type==='ore_golem_coal') dropItem(this.x,this.y,B_COAL,1 + Math.floor(Math.random()*2));
                if(this.type==='ore_golem_gold') dropItem(this.x,this.y,B_GOLD,1);
                if(this.type==='ore_beast_amethyst') dropItem(this.x,this.y,B_AMETHYST,1);
            } 
        } 
        updateUI();
    }
    draw(ctx, cx, cy) {
        if(this.invincible>0 && Math.floor(gameState.time/4)%2===0) return;
        let sx=this.x-cx, sy=this.y-cy;
        if (sx < -50 || sx > canvas.width + 50) return;

        ctx.save(); ctx.translate(sx+this.w/2, sy+this.h/2); if(!this.facingRight) ctx.scale(-1,1);
        let walk = this.walkFrame;
        
        if (this.type === 'slime') {
            let squash = Math.abs(this.vy) * 0.1; ctx.scale(1 - squash, 1 + squash);
            ctx.fillStyle = 'rgba(100, 255, 100, 0.6)'; ctx.fillRect(-10, -8, 20, 16);
            ctx.strokeStyle = '#2e7d32'; ctx.lineWidth=1; ctx.strokeRect(-10,-8,20,16);
            ctx.fillStyle = '#1b5e20'; ctx.fillRect(-6, -4, 12, 8);
            ctx.fillStyle = 'white'; ctx.fillRect(2, -5, 4, 4); ctx.fillRect(-6, -5, 4, 4);
            ctx.fillStyle = 'black'; ctx.fillRect(4, -4, 2, 2); ctx.fillRect(-4, -4, 2, 2);
        }
        else if (this.type === 'pig') {
            ctx.fillStyle = '#ad1457'; ctx.fillRect(-8 + walk*3, 6, 4, 6); ctx.fillRect(4 - walk*3, 6, 4, 6);
            ctx.fillStyle = '#f06292'; ctx.fillRect(-12, -8, 24, 14);
            ctx.fillRect(8, -10, 10, 10); ctx.fillStyle = '#e91e63'; ctx.fillRect(16, -6, 4, 4);
            ctx.fillStyle = 'white'; ctx.fillRect(12, -9, 3, 3); ctx.fillStyle = 'black'; ctx.fillRect(14, -8, 1, 1);
            ctx.strokeStyle = '#f06292'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-12,-6); ctx.quadraticCurveTo(-16, -10, -12, -2); ctx.stroke();
        }
        else if (this.type === 'sheep') {
            ctx.fillStyle = '#eee'; ctx.fillRect(-8 + walk*3, 6, 4, 6); ctx.fillRect(4 - walk*3, 6, 4, 6);
            ctx.fillStyle = '#fff'; ctx.fillRect(-12, -10, 24, 16); // Fluffy body
            ctx.fillStyle = '#e0e0e0'; ctx.fillRect(8, -12, 10, 10); // Head
            ctx.fillStyle = 'black'; ctx.fillRect(14, -10, 2, 2); ctx.fillStyle = '#f8bbd0'; ctx.fillRect(16, -8, 2, 2);
        }
        else if (this.type === 'chicken') {
            ctx.fillStyle = '#ffeb3b'; ctx.fillRect(-2 + walk*2, 6, 2, 4); ctx.fillRect(2 - walk*2, 6, 2, 4);
            ctx.fillStyle = '#fff'; ctx.fillRect(-6, -6, 12, 12);
            ctx.fillStyle = '#d32f2f'; ctx.fillRect(4, -8, 2, 2); // Crest
            ctx.fillStyle = '#ff9800'; ctx.fillRect(6, -2, 3, 2); // Beak
            ctx.fillStyle = 'black'; ctx.fillRect(4, -4, 1, 1);
        }
        else if (this.type === 'cow') {
            ctx.fillStyle = '#3e2723'; ctx.fillRect(-8 + walk*3, 6, 4, 6); ctx.fillRect(4 - walk*3, 6, 4, 6);
            ctx.fillStyle = '#5d4037'; ctx.fillRect(-12, -10, 24, 16);
            ctx.fillStyle = '#a1887f'; ctx.fillRect(-8, -8, 6, 6); ctx.fillRect(4, -6, 4, 4);
            ctx.fillStyle = '#5d4037'; ctx.fillRect(8, -12, 10, 10);
            ctx.fillStyle = '#eee'; ctx.fillRect(10, -14, 2, 4); ctx.fillRect(16, -14, 2, 4);
            ctx.fillStyle = 'white'; ctx.fillRect(12, -10, 3, 3); ctx.fillStyle = 'black'; ctx.fillRect(14, -9, 1, 1);
        }
        else if (this.type === 'spider') {
            let legY = Math.abs(walk)*2;
            ctx.fillStyle = '#000'; 
            ctx.fillRect(-14, 0-legY, 4, 10); ctx.fillRect(-6, 0+legY, 4, 10); ctx.fillRect(2, 0-legY, 4, 10); ctx.fillRect(10, 0+legY, 4, 10);
            ctx.fillStyle = '#212121'; ctx.fillRect(-10, -8, 20, 12); // Body
            ctx.fillStyle = '#d32f2f'; ctx.fillRect(6, -4, 2, 2); ctx.fillRect(2, -4, 2, 2); // Eyes
        }
        else if (this.type === 'robot') {
            ctx.fillStyle = '#546e7a'; ctx.fillRect(-8, 6, 6, 12); ctx.fillRect(2, 6, 6, 12); // Legs
            ctx.fillStyle = '#78909c'; ctx.fillRect(-10, -14, 20, 20); // Body
            ctx.fillStyle = '#37474f'; ctx.fillRect(-6, -22, 12, 8); // Head
            ctx.fillStyle = '#00e676'; ctx.fillRect(-2, -18, 2, 2); ctx.fillRect(2, -18, 2, 2); // Eyes
            ctx.fillStyle = '#cfd8dc'; ctx.fillRect(-12, -12, 4, 14); ctx.fillRect(8, -12, 4, 14); // Arms
        }
        else if (this.type.startsWith('ore_golem')) {
            let c = this.type==='ore_golem_gold'?'#ffd700':'#424242';
            ctx.fillStyle = '#616161'; ctx.fillRect(-10, 10, 8, 10); ctx.fillRect(2, 10, 8, 10); // Legs
            ctx.fillStyle = '#757575'; ctx.fillRect(-14, -14, 28, 24); // Body
            ctx.fillStyle = c; ctx.fillRect(-8, -8, 6, 6); ctx.fillRect(4, 0, 4, 4); // Ore spots
            ctx.fillStyle = '#212121'; ctx.fillRect(-6, -22, 12, 8); // Head
            ctx.fillStyle = '#f44336'; ctx.fillRect(-2, -18, 4, 2); // Eye
        }
        else if (this.type === 'ore_beast_amethyst') {
            ctx.fillStyle = '#4a148c'; ctx.fillRect(-12, 0, 24, 14); // Body
            ctx.fillStyle = '#d500f9'; ctx.beginPath(); ctx.moveTo(-6,-4); ctx.lineTo(0,-12); ctx.lineTo(6,-4); ctx.fill(); // Crystal spike
            ctx.fillStyle = '#8e24aa'; ctx.fillRect(-10, 10, 6, 6); ctx.fillRect(4, 10, 6, 6); // Legs
            ctx.fillStyle = '#fff'; ctx.fillRect(8, 2, 2, 2); // Eye
        }
        else {
            let legRot = walk * 0.5; let armRot = -walk * 0.5;
            if(this.type === 'zombie') armRot = -1.5; if(this.type === 'villager') armRot = -0.2;

            let skinColor = '#ffcc80'; let shirtColor = this.color; let pantsColor = '#212121';
            let hatColor = null; let bootColor = null; let pantsArmorColor = null;

            if(this.type === 'zombie') { skinColor = '#558b2f'; shirtColor = '#00acc1'; pantsColor = '#263238'; }
            if(this.type === 'skeleton') { skinColor = '#eeeeee'; shirtColor = 'transparent'; pantsColor = 'transparent'; }
            if(this.type === 'villager') { skinColor = '#d7ccc8'; shirtColor = '#5d4037'; pantsColor = '#3e2723'; }
            
            // Armor visual overrides
            if (this.type === 'player') {
                if(this.armor[0]) hatColor = ITEM_DATA[this.armor[0].id].color;
                if(this.armor[1]) shirtColor = ITEM_DATA[this.armor[1].id].color;
                if(this.armor[2]) pantsArmorColor = ITEM_DATA[this.armor[2].id].color;
                if(this.armor[3]) bootColor = ITEM_DATA[this.armor[3].id].color;
            }

            ctx.save(); ctx.translate(0, 6); ctx.rotate(-legRot);
            ctx.fillStyle = pantsArmorColor || (this.type==='skeleton' ? '#bdbdbd' : pantsColor); ctx.fillRect(-2, 0, 4, 12);
            if(bootColor) { ctx.fillStyle = bootColor; ctx.fillRect(-2, 9, 4, 3); }
            ctx.restore();

            if (this.type === 'skeleton') {
                ctx.fillStyle = '#eeeeee'; ctx.fillRect(-2, -8, 4, 14);
                if(shirtColor !== 'transparent') { ctx.fillStyle = shirtColor; ctx.fillRect(-3, -8, 6, 14); } // Armor on skeleton?
            } else {
                ctx.fillStyle = shirtColor; ctx.fillRect(-6, -8, 12, 14);
                if(this.type === 'villager') { ctx.fillStyle = '#3e2723'; ctx.fillRect(-1, -8, 2, 14); }
            }

            ctx.fillStyle = skinColor; ctx.fillRect(-6, -20, 12, 12);
            if(hatColor) { ctx.fillStyle = hatColor; ctx.fillRect(-7, -22, 14, 6); } // Helmet
            
            ctx.fillStyle = 'white'; ctx.fillRect(1, -17, 3, 3); ctx.fillStyle = 'black'; ctx.fillRect(3, -16, 1, 1);
            if(this.type === 'villager') { ctx.fillStyle = '#a1887f'; ctx.fillRect(2, -14, 4, 6); ctx.fillRect(-6, -20, 12, 4); }
            if(this.type === 'player' && !hatColor) { ctx.fillStyle = shadeColor(this.color, -30); ctx.fillRect(-6, -22, 12, 4); ctx.fillRect(-6, -20, 3, 8); }

            ctx.save(); ctx.translate(0, 6); ctx.rotate(legRot);
            ctx.fillStyle = pantsArmorColor || (this.type==='skeleton' ? '#eee' : pantsColor); ctx.fillRect(-2, 0, 4, 12);
            if(bootColor) { ctx.fillStyle = bootColor; ctx.fillRect(-2, 9, 4, 3); }
            ctx.restore();

            ctx.save(); ctx.translate(0, -6); ctx.rotate(armRot);
            if (this.type === 'skeleton') { ctx.fillStyle = '#eee'; ctx.fillRect(-1, 0, 2, 12); } 
            else { ctx.fillStyle = shirtColor; ctx.fillRect(-2, 0, 4, 6); ctx.fillStyle = skinColor; ctx.fillRect(-2, 6, 4, 6); }

            if(this.type === 'player') {
                let item = gameState.player.inventory[gameState.player.selectedSlot];
                if(item) {
                    let info = ITEM_DATA[item.id] || {color:'#fff'};
                    ctx.translate(0, 10); ctx.rotate(-Math.PI/2);
                    if(item.id >= 200) { 
                        ctx.fillStyle = '#5d4037'; ctx.fillRect(0, -2, 14, 2); ctx.fillStyle = info.color;
                        if(info.type === 'pickaxe' || item.id % 2 === 0) { ctx.beginPath(); ctx.arc(12, -2, 6, Math.PI/2, Math.PI*1.5); ctx.fill(); } 
                        else if(info.type === 'axe') { 
                            ctx.fillRect(4, -6, 10, 4); ctx.beginPath(); ctx.moveTo(4,-4); ctx.lineTo(4,-12); ctx.lineTo(14,-8); ctx.fill(); // Crude Axe shape
                        }
                        else if(info.type === 'sickle') { 
                            ctx.beginPath(); ctx.arc(10, -10, 8, 0, Math.PI, false); ctx.stroke(); // Sickle curve attempt
                        }
                        else if(info.type === 'knife') { ctx.fillRect(4, -2, 8, 4); }
                        else { ctx.fillRect(4, -4, 16, 6); }
                    } else if(item.id === ITEM_BACON || item.id === ITEM_STEAK) {
                        ctx.fillStyle = info.color; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
                    } else { ctx.fillStyle = info.color; ctx.fillRect(0, -4, 8, 8); }
                }
            }
            ctx.restore();
        }
        ctx.restore();
    }
}

class DroppedItem {
    constructor(x, y, id, count) {
        this.x = x; this.y = y; this.id = id; this.count = count;
        this.vx = (Math.random()-0.5)*4; this.vy = -4; this.w = 16; this.h = 16; this.pickupDelay = 60; 
    }
    update() {
        if(this.pickupDelay > 0) this.pickupDelay--;
        this.vy += GRAVITY; this.x += this.vx; this.y += this.vy;
        let bx = Math.floor(this.x/BLOCK_SIZE), by = Math.floor((this.y+this.h)/BLOCK_SIZE);
        if(getBlock(bx, by) !== B_AIR && getBlock(bx, by) !== B_WATER) { this.y = by*BLOCK_SIZE - this.h; this.vy = 0; this.vx *= 0.8; }

        if (this.pickupDelay === 0 && checkRectOverlap(this, gameState.player)) {
            let leftover = addItemToInventory(this.id, this.count);
            if (leftover === 0) this.dead = true; else this.count = leftover;
        }
    }
    draw(ctx, camX, camY) {
        let sx = this.x - camX, sy = this.y - camY;
        let info = ITEM_DATA[this.id] || {color:'#fff', name:'?'};
        ctx.fillStyle = info.color;
        ctx.fillRect(sx, sy, this.w, this.h);
        ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.strokeRect(sx, sy, this.w, this.h);
        if(info.icon) { ctx.fillStyle = '#000'; ctx.font = '12px Arial'; ctx.fillText(info.icon, sx+2, sy+12); }
    }
}

class Player extends Entity {
    constructor(name, color) {
        super(0, 0, 24, 34, color, 'player');
        this.name = name;
        this.inventory = new Array(TOTAL_INV_SIZE).fill(null);
        // 0: Helm, 1: Chest, 2: Legs, 3: Boots
        this.armor = [null, null, null, null]; 
        
        this.inventory[0] = { id: ITEM_WOOD_PICKAXE, count: 1 };
        this.inventory[1] = { id: ITEM_WOOD_SWORD, count: 1 };
        this.selectedSlot = 0;
        this.hunger = 20; this.maxHunger = 20;
    }
    update() {
        if (gameState.isInventoryOpen) return;
        
        let speed = this.inWater ? 0.3 : 0.5;
        
        // Redstone Ability: Speed (Boots)
        if (this.armor[3] && (this.armor[3].id === ARMOR_REDSTONE_BOOTS || this.armor[3].id === ARMOR_SURREAL_BOOTS)) speed *= 1.5;

        if (input.keys['KeyA'] || input.keys['ArrowLeft']) { this.vx -= speed; this.facingRight = false; }
        if (input.keys['KeyD'] || input.keys['ArrowRight']) { this.vx += speed; this.facingRight = true; }
        
        let jumpKey = input.keys['KeyW'] || input.keys['ArrowUp'] || input.keys['Space'];
        if (jumpKey) { 
            if (this.grounded) {
                let jumpForce = -8.5;
                // Redstone Ability: Jump (Chest)
                if (this.armor[1] && (this.armor[1].id === ARMOR_REDSTONE_CHEST || this.armor[1].id === ARMOR_SURREAL_CHEST)) jumpForce = -11;
                this.vy = jumpForce; 
            }
            else if (this.inWater) this.vy -= 0.5; 
        }

        super.update();
        if(input.keys['KeyQ']) { 
            let item = this.inventory[this.selectedSlot];
            if (item) {
                dropItem(this.x, this.y, item.id, 1);
                item.count--; if(item.count<=0) this.inventory[this.selectedSlot] = null;
                input.keys['KeyQ'] = false; updateInventoryUI();
            }
        }
        this.handleAction();
        
        if (gameState.time % 7200 === 0) { if(this.hunger > 0) { this.hunger = Math.max(0, this.hunger - 2); updateUI(); showMessage("Fome aumentou!"); } }
        
        if (gameState.time % 120 === 0) {
            if (this.hunger >= 18 && this.health < this.maxHealth) { this.health++; updateUI(); } 
            else if (this.hunger === 0) { this.takeDamage(1); updateUI(); }
        }
    }
    handleAction() {
        let mx = input.mouseX + gameState.camera.x; let my = input.mouseY + gameState.camera.y;
        let bx = Math.floor(mx / BLOCK_SIZE); let by = Math.floor(my / BLOCK_SIZE);
        let targetBlock = getBlock(bx, by); let item = this.inventory[this.selectedSlot];
        
        if (Math.hypot(mx - (this.x + this.w/2), my - (this.y + this.h/2)) > 250) { this.miningState.active = false; return; }

        let stats = getToolStats(item ? item.id : 0);

        // Combat
        if (input.click && (stats.damage > 1 || stats.type === 'sword' || stats.type === 'staff' || stats.type === 'axe' || stats.type === 'sickle' || stats.type === 'knife')) {
            if(input.clickCooldown > 0) return;
            
            if(item && item.id === ITEM_MAGIC_STAFF) { 
                shootProjectile(this.x+this.w/2, this.y+this.h/3, mx, my, this); 
                input.clickCooldown = stats.cooldown; 
                return; 
            }
            
            input.clickCooldown = stats.cooldown; 
            addParticle(mx, my, '#fff', 2);
            
            gameState.entities.forEach(ent => { 
                if(ent !== this && checkRectOverlap({x:mx-20, y:my-20, w:40, h:40}, ent)) {
                    ent.takeDamage(stats.damage); 
                }
            });
            
            if(stats.type !== 'pickaxe' && stats.type !== 'axe') return;
        }

        if ((input.rightClick || (input.click && item && item.id < 100)) && (targetBlock === B_AIR || targetBlock === B_WATER)) {
            if (item && (item.id === ITEM_BACON || item.id === ITEM_STEAK || item.id === ITEM_CHICKEN_RAW)) {
                if (input.clickCooldown > 0) return;
                if (this.hunger < this.maxHunger) {
                    let restore = item.id === ITEM_BACON ? 4 : (item.id === ITEM_CHICKEN_RAW ? 2 : 6);
                    this.hunger = Math.min(this.maxHunger, this.hunger + restore);
                    showMessage("Nhac! Del√≠cia.");
                    item.count--; if(item.count<=0) this.inventory[this.selectedSlot] = null;
                    input.clickCooldown = 30; updateInventoryUI(); updateUI(); return;
                }
            }
            if (item && item.id < 100) {
                if (input.clickCooldown > 0) return;
                let rect = {x: bx*BLOCK_SIZE, y: by*BLOCK_SIZE, w: BLOCK_SIZE, h: BLOCK_SIZE};
                if (!checkRectOverlap(rect, this)) {
                    setBlock(bx, by, item.id);
                    item.count--; if(item.count <= 0) this.inventory[this.selectedSlot] = null;
                    input.clickCooldown = 15; updateInventoryUI(); return; 
                }
            }
        }

        if (input.click && targetBlock !== B_AIR && targetBlock !== B_WATER && targetBlock !== B_BEDROCK) {
            if (this.miningState.x !== bx || this.miningState.y !== by) { this.miningState.active = false; this.miningState.progress = 0; }
            
            let power = stats.power; 
            let hardness = BLOCK_HARDNESS[targetBlock] || 20;
            
            // Efficiency Bonuses
            if (stats.type === 'axe' && (targetBlock === B_LOG || targetBlock === B_WOOD || targetBlock === B_PLANKS)) {
                power *= 3; // Axes break wood fast
            }
            if (stats.type === 'pickaxe' && (targetBlock === B_STONE || targetBlock === B_COAL || targetBlock === B_IRON || targetBlock === B_GOLD || targetBlock === B_DIAMOND || targetBlock === B_COPPER || targetBlock === B_AMETHYST || targetBlock === B_EMERALD || targetBlock === B_RUBY || targetBlock === B_TITANIUM)) {
                power *= 1.5; // Pickaxes break stone slightly faster
            }

            this.miningState.active = true; this.miningState.x = bx; this.miningState.y = by; this.miningState.progress += power;
            if (gameState.time % 5 === 0) addParticle(mx, my, COLORS[targetBlock] || '#fff', 3);
            if (this.miningState.progress >= hardness) {
                let leftover = addItemToInventory(targetBlock, 1);
                if(leftover > 0) dropItem(mx, my, targetBlock, leftover);
                setBlock(bx, by, B_AIR);
                this.miningState.active = false; this.miningState.progress = 0;
                addParticle(mx, my, COLORS[targetBlock], 10);
            }
        } else { this.miningState.active = false; this.miningState.progress = 0; }
    }
}

function getBlock(x, y) {
    if (y < 0 || y >= CHUNK_HEIGHT) return B_BEDROCK;
    let cx = Math.floor(x / CHUNK_WIDTH);
    let lx = ((x % CHUNK_WIDTH) + CHUNK_WIDTH) % CHUNK_WIDTH;
    let chunk = gameState.chunks[cx];
    if (!chunk) return B_BEDROCK;
    return chunk[y * CHUNK_WIDTH + lx];
}

function setBlock(x, y, id) {
    if (y < 0 || y >= CHUNK_HEIGHT) return;
    let cx = Math.floor(x / CHUNK_WIDTH);
    let lx = ((x % CHUNK_WIDTH) + CHUNK_WIDTH) % CHUNK_WIDTH;
    if (gameState.chunks[cx]) gameState.chunks[cx][y * CHUNK_WIDTH + lx] = id;
}

function noise(x, y) { return Math.sin(x * 0.1) + Math.cos(y * 0.1) + Math.sin(x * 0.3 + y * 0.2); }

function switchDimension(portalType) {
    let dim = 'overworld';
    if(portalType === B_PORTAL_NETHER) dim = 'nether';
    if(portalType === B_PORTAL_AETHER) dim = 'aether';
    if(portalType === B_PORTAL_PRISON) dim = 'prison';
    if(portalType === B_PORTAL_EVEREST) dim = 'everest';
    
    if (dim === gameState.dimension) return;

    showMessage("Viajando para " + dim.toUpperCase() + "...");
    gameState.dimension = dim;
    gameState.chunks = {};
    gameState.generatedChunks = new Set();
    gameState.entities = [gameState.player]; 
    gameState.droppedItems = [];
    
    let spawnY = 0;
    
    if (dim === 'prison') {
        spawnY = 50 * BLOCK_SIZE;
        gameState.player.x = 0;
    } else {
        for(let i=-2; i<=2; i++) generateChunk(i);
        for(let y=0; y<CHUNK_HEIGHT; y++) {
            if(getBlock(0, y) !== B_AIR) { spawnY = (y-3)*BLOCK_SIZE; break; }
        }
    }
    
    gameState.player.y = spawnY;
    gameState.player.vx = 0;
    gameState.player.vy = 0;
}

function generateChunk(cx) {
    if (gameState.generatedChunks.has(cx)) return;
    let chunkData = new Array(CHUNK_WIDTH * CHUNK_HEIGHT).fill(B_AIR);
    let startX = cx * CHUNK_WIDTH;
    
    let dim = gameState.dimension;

    // --- OVERWORLD ---
    if (dim === 'overworld') {
        let hasMine = Math.random() < 0.2; let mineY = 60 + Math.floor(Math.random() * 30);
        for (let lx = 0; lx < CHUNK_WIDTH; lx++) {
            let worldX = startX + lx;
            let hNoise = Math.sin(worldX*0.05)*10 + Math.sin(worldX*0.02)*20 + Math.sin(worldX*0.1)*2;
            let surfaceY = Math.floor(40 + hNoise);
            
            for (let y = 0; y < CHUNK_HEIGHT; y++) {
                let idx = y * CHUNK_WIDTH + lx;
                if (y >= CHUNK_HEIGHT - 2) { chunkData[idx] = B_BEDROCK; continue; }
                if (y > surfaceY && y < SEA_LEVEL) { chunkData[idx] = B_WATER; if (y === surfaceY + 1) chunkData[idx] = B_SAND; continue; }

                if (y >= surfaceY) {
                    if (y === surfaceY) { if (y >= SEA_LEVEL - 2) chunkData[idx] = B_SAND; else chunkData[idx] = B_GRASS; }
                    else if (y < surfaceY + 5) chunkData[idx] = B_DIRT; else chunkData[idx] = B_STONE;
                    
                    if (noise(worldX, y) > 1.2 && y > surfaceY + 5) chunkData[idx] = B_AIR;

                    if(chunkData[idx] === B_STONE) {
                        let r = Math.random();
                        if(r < 0.03) chunkData[idx] = B_COAL;
                        else if(r < 0.02 && y < 60) chunkData[idx] = B_COPPER; 
                        else if(r < 0.015 && y > 30) chunkData[idx] = B_IRON;
                        else if(r < 0.008 && y > 60) chunkData[idx] = B_GOLD;
                        else if(r < 0.005 && y > 75) chunkData[idx] = B_AMETHYST; 
                        else if(r < 0.005 && y > 80) chunkData[idx] = B_REDSTONE; 
                        else if(r < 0.003 && y > 90) chunkData[idx] = B_DIAMOND;
                        else if(y > 100 && r < 0.05) chunkData[idx] = B_HELLSTONE;
                        else if(y > 80 && r < 0.001) chunkData[idx] = B_RUBY;
                        else if(y > 100 && r < 0.001) chunkData[idx] = B_TITANIUM;
                    }
                } 
                if (y === surfaceY - 1 && y < SEA_LEVEL - 5) { if (Math.random() < 0.2) chunkData[idx] = B_TALLGRASS; else if (Math.random() < 0.05) chunkData[idx] = B_FLOWER; }
            }
            let surfaceBlock = chunkData[surfaceY * CHUNK_WIDTH + lx];
            if (worldX % 6 === 0 && Math.random() > 0.4 && surfaceBlock === B_GRASS && surfaceY < SEA_LEVEL - 2) {
                let h = 4 + Math.floor(Math.random()*4);
                for(let i=1; i<=h; i++) if(surfaceY-i > 0) chunkData[(surfaceY-i)*CHUNK_WIDTH + lx] = B_LOG;
                for(let fx=-2; fx<=2; fx++) { for(let fy=-2; fy<=0; fy++) { let leafY = surfaceY - h + fy; let lIdx = leafY * CHUNK_WIDTH + (lx+fx); if (lx+fx >=0 && lx+fx < CHUNK_WIDTH && chunkData[lIdx] === B_AIR) chunkData[lIdx] = B_LEAVES; } }
            }
            if (hasMine && chunkData[mineY * CHUNK_WIDTH + lx] !== B_AIR) {
                chunkData[mineY * CHUNK_WIDTH + lx] = B_AIR; chunkData[(mineY-1) * CHUNK_WIDTH + lx] = B_AIR; chunkData[(mineY+1) * CHUNK_WIDTH + lx] = B_PLANKS;
                if (lx % 5 === 0) { chunkData[(mineY-1) * CHUNK_WIDTH + lx] = B_PLANKS; chunkData[mineY * CHUNK_WIDTH + lx] = B_TORCH; }
            }
        }
    }
    else if (dim === 'nether') {
        for (let lx = 0; lx < CHUNK_WIDTH; lx++) {
            for (let y = 0; y < CHUNK_HEIGHT; y++) {
                let idx = y * CHUNK_WIDTH + lx;
                if (y === 0 || y === CHUNK_HEIGHT - 1) chunkData[idx] = B_BEDROCK;
                else {
                    if (y < 10 || y > 100) chunkData[idx] = B_HELLSTONE;
                    else {
                        if (Math.sin(lx*0.1 + startX*0.1) * Math.cos(y*0.1) > 0.2) chunkData[idx] = B_HELLSTONE;
                        else if (y > 90) chunkData[idx] = B_WATER;
                    }
                }
            }
        }
    }
    else if (dim === 'aether') {
        for (let lx = 0; lx < CHUNK_WIDTH; lx++) {
            let worldX = startX + lx;
            let hNoise = Math.sin(worldX*0.1)*10;
            for (let y = 0; y < CHUNK_HEIGHT; y++) {
                let idx = y * CHUNK_WIDTH + lx;
                if (y > 40 + hNoise && y < 60 + hNoise) {
                    if (y === 41 + Math.floor(hNoise)) chunkData[idx] = B_GRASS;
                    else chunkData[idx] = B_DIRT;
                    if (Math.random() < 0.05) chunkData[idx] = B_GLOWSTONE;
                }
            }
        }
    }
    else if (dim === 'prison') {
        for (let lx = 0; lx < CHUNK_WIDTH; lx++) {
            let worldX = startX + lx;
            for (let y = 0; y < CHUNK_HEIGHT; y++) {
                let idx = y * CHUNK_WIDTH + lx;
                if (y > 60) chunkData[idx] = B_STONE;
                if (y === 60) chunkData[idx] = B_BRICK;
                if (y < 60 && y > 50 && worldX % 10 === 0) chunkData[idx] = B_IRON_BARS; 
            }
        }
    }
    else if (dim === 'everest') {
        for (let lx = 0; lx < CHUNK_WIDTH; lx++) {
            let worldX = startX + lx;
            let hNoise = Math.sin(worldX*0.05)*30 + Math.sin(worldX*0.01)*50;
            let surfaceY = Math.floor(80 + hNoise);
            
            for (let y = 0; y < CHUNK_HEIGHT; y++) {
                let idx = y * CHUNK_WIDTH + lx;
                if (y > surfaceY) {
                    if (y === surfaceY + 1) chunkData[idx] = B_SNOW;
                    else chunkData[idx] = B_STONE;
                    if (y > 110 && Math.random() < 0.01) chunkData[idx] = B_TITANIUM;
                }
            }
        }
    }

    gameState.chunks[cx] = chunkData; gameState.generatedChunks.add(cx);
}

function initGame(name, color) {
    document.getElementById('hero-select').style.display = 'none';
    for(let i=-2; i<=2; i++) generateChunk(i);
    gameState.player = new Player(name, color);
    
    let spawnX = 0; let spawnY = 0;
    for(let s=0; s<100; s++) { let h = getTerrainHeight(s); if (h < SEA_LEVEL - 5) { spawnX = s*BLOCK_SIZE; spawnY = (h-2)*BLOCK_SIZE; break; } }
    if(spawnY === 0) spawnY = (getTerrainHeight(0)-2)*BLOCK_SIZE;
    gameState.player.x = spawnX; gameState.player.y = spawnY;
    gameState.entities.push(gameState.player);
    gameState.isMenu = false;
    updateInventoryUI(); updateUI(); loop();
}

function getTerrainHeight(x) {
    let bx = Math.floor(x);
    for(let y=0; y<CHUNK_HEIGHT; y++) { let b = getBlock(bx, y); if (b === B_GRASS || b === B_SAND || b === B_STONE) return y; }
    return 50;
}

function loop() {
    if (gameState.isMenu) return;
    requestAnimationFrame(loop);
    if (input.keys['KeyE']) { toggleInventory(); input.keys['KeyE'] = false; }

    if (!gameState.isInventoryOpen) {
        gameState.time++;
        if (gameState.time >= 24000) { gameState.time = 0; gameState.dayCount++; showMessage("Dia " + gameState.dayCount); }

        let centerChunk = Math.floor((gameState.camera.x + canvas.width/2) / (CHUNK_WIDTH * BLOCK_SIZE));
        for(let i = centerChunk - 2; i <= centerChunk + 3; i++) generateChunk(i);
        
        let isDay = gameState.time > 5000 && gameState.time < 18000;
        if (Math.random() < 0.01 && gameState.entities.length < 20) { 
            let rCx = centerChunk + (Math.random() > 0.5 ? 1 : -1) * (2 + Math.random() * 2);
            let rLx = Math.floor(Math.random() * CHUNK_WIDTH);
            let spawnX = (Math.floor(rCx) * CHUNK_WIDTH + rLx) * BLOCK_SIZE;
            let spawnY = -100;
            for(let y=0; y<CHUNK_HEIGHT; y++) { if (getBlock(spawnX/BLOCK_SIZE, y) !== B_AIR && getBlock(spawnX/BLOCK_SIZE, y) !== B_WATER) { spawnY = (y-2) * BLOCK_SIZE; break; } }

            if (spawnY > 0) {
                let type = null;
                let dim = gameState.dimension;
                
                if (dim === 'overworld') {
                    let isSurface = spawnY < 60 * BLOCK_SIZE;
                    let isDeep = spawnY > 80 * BLOCK_SIZE;
                    let ground = getBlock(spawnX/BLOCK_SIZE, (spawnY/BLOCK_SIZE)+2);
                    
                    if (isDay && isSurface && ground === B_GRASS) {
                        let r = Math.random();
                        if(r < 0.25) type = 'pig';
                        else if(r < 0.5) type = 'cow';
                        else if(r < 0.75) type = 'sheep';
                        else type = 'chicken';
                    } 
                    else if (!isDay && isSurface) {
                         let r = Math.random();
                         if(r < 0.4) type = 'zombie';
                         else if(r < 0.7) type = 'skeleton';
                         else type = 'spider';
                    }
                    else if (!isSurface) { // Underground
                        let r = Math.random();
                        if (isDeep) {
                             if(r < 0.3) type = 'ore_golem_gold';
                             else if(r < 0.4) type = 'ore_beast_amethyst';
                             else if(r < 0.6) type = 'robot';
                             else type = 'skeleton';
                        } else {
                             if(r < 0.2) type = 'ore_golem_coal';
                             else if(r < 0.4) type = 'spider';
                             else type = 'zombie';
                        }
                    }
                } 
                else if (dim === 'nether') { type = 'skeleton'; } 
                else if (dim === 'aether') { type = 'slime'; } 
                else if (dim === 'prison') { type = Math.random()>0.5 ? 'robot' : 'zombie'; } 
                else if (dim === 'everest') { type = Math.random()>0.5 ? 'robot' : 'skeleton'; }
                
                if (type) {
                    let color = '#fff';
                    if(type === 'zombie') color = '#4caf50'; else if(type === 'skeleton') color = '#e0e0e0';
                    else if(type === 'slime') color = '#00e676'; else if(type === 'pig') color = '#f06292';
                    let w=24, h=34; 
                    if(['pig','cow','sheep','spider'].includes(type)) { w=30; h=20; } 
                    if(type === 'chicken' || type === 'slime') { w=20; h=20; }
                    if(type.startsWith('ore_golem')) { w=32; h=40; }
                    if(type === 'ore_beast_amethyst') { w=40; h=30; }
                    
                    gameState.entities.push(new Entity(spawnX, spawnY, w, h, color, type));
                }
            }
        }

        gameState.entities = gameState.entities.filter(e => !e.dead);
        gameState.entities.forEach(e => e.update());
        gameState.droppedItems.forEach((it, i) => { it.update(); if(it.dead) gameState.droppedItems.splice(i, 1); });
        gameState.particles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.life--; if(p.life<=0)gameState.particles.splice(i,1); });
        gameState.projectiles.forEach((p, i) => { p.update(); if (p.life <= 0) gameState.projectiles.splice(i, 1); });
        
        gameState.camera.x += (gameState.player.x - canvas.width/2 - gameState.camera.x) * 0.1;
        gameState.camera.y += (gameState.player.y - canvas.height/2 - gameState.camera.y) * 0.1;
        if(input.clickCooldown > 0) input.clickCooldown--;
    }
    draw();
}

function draw() {
    let w = canvas.width, h = canvas.height;
    let cx = gameState.camera.x, cy = gameState.camera.y;
    
    let dim = gameState.dimension;
    if (dim === 'overworld') {
        let t = gameState.time;
        if (t < 5000) ctx.fillStyle = '#0d1b2a';
        else if (t < 7000) ctx.fillStyle = '#ff7043';
        else if (t < 16000) ctx.fillStyle = '#81d4fa';
        else if (t < 19000) ctx.fillStyle = '#ff7043';
        else ctx.fillStyle = '#0d1b2a';
    }
    else if (dim === 'nether') ctx.fillStyle = '#3e0000';
    else if (dim === 'aether') ctx.fillStyle = '#fff9c4'; 
    else if (dim === 'prison') ctx.fillStyle = '#212121'; 
    else if (dim === 'everest') ctx.fillStyle = '#e1f5fe'; 
    
    ctx.fillRect(0, 0, w, h);

    // Sun/Moon for Overworld
    if (dim === 'overworld') {
        let t = gameState.time;
        let celestialX = (t / 24000) * w;
        let celestialY = h/3 + Math.sin(t/24000 * Math.PI * 2) * 50;
        
        if (t > 5000 && t < 19000) {
            ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(celestialX, celestialY, 40, 0, Math.PI*2); ctx.fill(); // Sun
        } else {
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(celestialX, celestialY, 30, 0, Math.PI*2); ctx.fill(); // Moon
        }
    }

    let voidY = CHUNK_HEIGHT * BLOCK_SIZE - cy;
    if (voidY < h) { ctx.fillStyle = '#000'; ctx.fillRect(0, voidY, w, h - voidY); }

    let startChunk = Math.floor(cx / (CHUNK_WIDTH * BLOCK_SIZE));
    let endChunk = Math.floor((cx + w) / (CHUNK_WIDTH * BLOCK_SIZE)) + 1;

    for (let c = startChunk; c <= endChunk; c++) {
        let chunk = gameState.chunks[c];
        if (!chunk) continue;
        for (let lx = 0; lx < CHUNK_WIDTH; lx++) {
            let worldX = c * CHUNK_WIDTH + lx;
            let screenX = Math.floor(worldX * BLOCK_SIZE - cx);
            if (screenX < -BLOCK_SIZE || screenX > w) continue;
            
            let hNoise = Math.sin(worldX*0.05)*10 + Math.sin(worldX*0.02)*20 + Math.sin(worldX*0.1)*2;
            let surfaceY = Math.floor(40 + hNoise);
            if (dim !== 'overworld') surfaceY = -999; 

            let startRow = Math.max(0, Math.floor(cy / BLOCK_SIZE));
            let endRow = Math.min(CHUNK_HEIGHT, Math.floor((cy + h) / BLOCK_SIZE) + 1);

            for (let y = startRow; y < endRow; y++) {
                let id = chunk[y * CHUNK_WIDTH + lx];
                let screenY = Math.floor(y * BLOCK_SIZE - cy);

                if (y > surfaceY + 2 && dim === 'overworld') { 
                    ctx.fillStyle = '#261612'; ctx.fillRect(screenX, screenY, BLOCK_SIZE, BLOCK_SIZE);
                }

                if (id !== B_AIR) {
                    if (id === B_WATER) { ctx.fillStyle = dim==='nether'?'#d32f2f':COLORS[id]; ctx.fillRect(screenX, screenY, BLOCK_SIZE, BLOCK_SIZE); } 
                    else {
                        ctx.fillStyle = COLORS[id] || '#f0f'; ctx.fillRect(screenX, screenY, BLOCK_SIZE, BLOCK_SIZE);
                        if (gameState.player.miningState.active && gameState.player.miningState.x === worldX && gameState.player.miningState.y === y) {
                            let prog = gameState.player.miningState.progress / (BLOCK_HARDNESS[id]||20);
                            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(screenX + 10, screenY + 10, (BLOCK_SIZE-20) * prog, BLOCK_SIZE-20);
                        }
                    }
                }
            }
        }
    }
    
    gameState.droppedItems.forEach(i => i.draw(ctx, cx, cy));
    gameState.entities.forEach(e => e.draw(ctx, cx, cy));
    gameState.particles.forEach(p => { ctx.fillStyle=p.color; ctx.fillRect(p.x-cx, p.y-cy, p.size, p.size); });
    gameState.projectiles.forEach(p => { ctx.fillStyle='#b0f'; ctx.beginPath(); ctx.arc(p.x-cx, p.y-cy, 5, 0, Math.PI*2); ctx.fill(); });

    let mx = input.mouseX, my = input.mouseY;
    let bx = Math.floor((mx + cx) / BLOCK_SIZE);
    let by = Math.floor((my + cy) / BLOCK_SIZE);
    
    ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.strokeRect(bx*BLOCK_SIZE - cx, by*BLOCK_SIZE - cy, BLOCK_SIZE, BLOCK_SIZE);
    
    if(gameState.cursorItem) {
        let info = ITEM_DATA[gameState.cursorItem.id];
        ctx.fillStyle = info ? info.color : '#fff';
        if(info && info.icon) { ctx.font = '20px Arial'; ctx.fillText(info.icon, mx, my); } else ctx.fillRect(mx - 10, my - 10, 20, 20);
    } else { ctx.fillStyle = 'white'; ctx.fillRect(mx-2, my-2, 4, 4); }
}

// UI
function updateUI() {
    const hpDiv = document.getElementById('health-bar'); hpDiv.innerHTML = '';
    let hearts = Math.ceil(gameState.player.health / 20);
    for(let i=0; i<hearts; i++) { let h=document.createElement('div'); h.className='heart'; hpDiv.appendChild(h); }

    const armorDiv = document.getElementById('armor-bar'); armorDiv.innerHTML = '';
    let defense = 0;
    gameState.player.armor.forEach(a => { if(a) defense += (ITEM_DATA[a.id].defense || 0); });
    let armorIcons = Math.ceil(defense / 5); // 1 icon per 5 defense roughly
    for(let i=0; i<armorIcons; i++) { let a=document.createElement('div'); a.className='armor-icon-hud'; armorDiv.appendChild(a); }

    const hungDiv = document.getElementById('hunger-bar'); hungDiv.innerHTML = '';
    let hungerIcons = Math.ceil(gameState.player.maxHunger / 2);
    let currentHungerIcons = Math.ceil(gameState.player.hunger / 2);
    for(let i=0; i<hungerIcons; i++) { let h = document.createElement('div'); h.className = 'food-icon' + (i >= currentHungerIcons ? ' food-missing' : ''); hungDiv.appendChild(h); }
}

function updateInventoryUI() {
    let p = gameState.player; if(!p) return;
    let hud = document.getElementById('hud-hotbar'); hud.innerHTML='';
    for(let i=0;i<9;i++) {
        let d=document.createElement('div'); d.className='slot '+(p.selectedSlot===i?'active':'');
        d.onclick=()=>{p.selectedSlot=i;updateInventoryUI();};
        d.innerHTML=slotHTML(p.inventory[i]); hud.appendChild(d);
    }
    if(gameState.isInventoryOpen) {
        let grid = document.getElementById('main-inventory-grid'); grid.innerHTML='';
        for(let i=9; i<TOTAL_INV_SIZE; i++) {
            let d=document.createElement('div'); d.className='slot'; d.onmousedown=(e)=>slotClick(i,e.button); d.innerHTML=slotHTML(p.inventory[i]); grid.appendChild(d);
        }
        let hot = document.getElementById('inv-hotbar-grid'); hot.innerHTML='';
        for(let i=0; i<9; i++) {
            let d=document.createElement('div'); d.className='slot'; d.onmousedown=(e)=>slotClick(i,e.button); d.innerHTML=slotHTML(p.inventory[i]); hot.appendChild(d);
        }
        
        // Armor Slots
        for(let i=0; i<4; i++) {
            let el = document.getElementById('armor-slot-'+i);
            let item = p.armor[i];
            let ph = ['ü™ñ','üëï','üëñ','üë¢'][i];
            el.innerHTML = item ? slotHTML(item) : `<div class="slot-placeholder">${ph}</div>`;
        }

        let cr = document.getElementById('crafting-grid'); cr.innerHTML='';
        RECIPES.forEach(r => {
            let can = true;
            r.cost.forEach(c => {
               let has = p.inventory.reduce((a,it)=>(it&&it.id===c.id)?a+it.count:a, 0);
               if(has<c.n) can=false;
            });
            let d=document.createElement('div'); d.className='slot'; 
            if(!can) d.style.opacity=0.3; else d.onclick=()=>craft(r);
            d.onmouseenter=(e)=>showTooltip(e, r); d.onmouseleave=hideTooltip;
            let info = ITEM_DATA[r.out]||{};
            
            let inner = '';
            if (info.icon) {
                inner = `<div class="item-icon" style="color:${info.color}">${info.icon}</div>`;
            } else {
                inner = `<div class="item-block" style="background-color:${info.color}"></div>`;
            }
            d.innerHTML = `${inner}<div class="item-count" style="color:#fff; text-shadow:1px 1px 0 #000">${r.count > 1 ? r.count : ''}</div>`;
            
            cr.appendChild(d);
        });
    }
}
function slotHTML(item) {
    if(!item) return '';
    let info = ITEM_DATA[item.id]||{color:'#fff'};
    if (info.icon) {
        return `<div class="item-icon" style="color:${info.color}">${info.icon}</div><div class="item-count">${item.count>1?item.count:''}</div>`;
    } else {
        return `<div class="item-block" style="background-color:${info.color}"></div><div class="item-count">${item.count>1?item.count:''}</div>`;
    }
}
function slotClick(i, btn) {
    let p = gameState.player;
    let item = p.inventory[i];
    let cursor = gameState.cursorItem;
    if(cursor) {
        if(item && item.id===cursor.id) { item.count+=cursor.count; gameState.cursorItem=null; }
        else { p.inventory[i] = cursor; gameState.cursorItem = item; }
    } else if(item) {
        if(btn===2) { // Right click split
            let half = Math.ceil(item.count/2);
            gameState.cursorItem = {id:item.id, count:half};
            item.count-=half; if(item.count===0) p.inventory[i]=null;
        } else {
            gameState.cursorItem = item; p.inventory[i] = null;
        }
    }
    updateInventoryUI();
}

function armorSlotClick(slotIdx) {
    let p = gameState.player;
    let currentArmor = p.armor[slotIdx];
    let cursor = gameState.cursorItem;

    if (cursor) {
        let info = ITEM_DATA[cursor.id];
        // Check if item is valid armor for this slot
        if (info.armorType === slotIdx) {
            p.armor[slotIdx] = cursor;
            gameState.cursorItem = currentArmor; // Swap
        }
    } else if (currentArmor) {
        // Unequip
        gameState.cursorItem = currentArmor;
        p.armor[slotIdx] = null;
    }
    updateInventoryUI();
    updateUI();
}

function craft(r) {
    let p=gameState.player;
    r.cost.forEach(c=>{
        let need=c.n;
        for(let i=0; i<p.inventory.length; i++) {
            if(p.inventory[i] && p.inventory[i].id===c.id) {
                let take = Math.min(need, p.inventory[i].count);
                p.inventory[i].count-=take; need-=take;
                if(p.inventory[i].count<=0) p.inventory[i]=null;
                if(need<=0) break;
            }
        }
    });
    addItemToInventory(r.out, r.count);
    updateInventoryUI();
}
function addItemToInventory(id, n) {
    let p=gameState.player;
    for(let i=0;i<p.inventory.length;i++) if(p.inventory[i] && p.inventory[i].id===id) { p.inventory[i].count+=n; return 0; }
    for(let i=0;i<p.inventory.length;i++) if(!p.inventory[i]) { p.inventory[i]={id:id,count:n}; return 0; }
    return n;
}
function toggleInventory() { 
    gameState.isInventoryOpen = !gameState.isInventoryOpen; 
    document.getElementById('inventory-screen').style.display=gameState.isInventoryOpen?'flex':'none'; 
    updateInventoryUI(); 
}
function showTooltip(e, r) {
    let t=document.getElementById('tooltip'); t.style.display='block';
    t.style.left=(e.clientX+10)+'px'; t.style.top=(e.clientY+10)+'px';
    let stats = getToolStats(r.out);
    let itemInfo = ITEM_DATA[r.out];
    
    let extraText = '';
    if (stats.power>1) extraText += `<div class="stats">For√ßa: ${stats.power} | Dano: ${stats.damage}</div>`;
    if (itemInfo.defense) extraText += `<div class="stats">Defesa: ${itemInfo.defense}</div>`;
    
    // Skill Text
    if (r.out === ARMOR_REDSTONE_BOOTS) extraText += `<div class="stats" style="color:#ff1744">Habilidade: Super Velocidade</div>`;
    if (r.out === ARMOR_REDSTONE_CHEST) extraText += `<div class="stats" style="color:#ff1744">Habilidade: Super Pulo</div>`;

    let costs = r.cost.map(c=> {
        let has = gameState.player.inventory.reduce((a,it)=>(it&&it.id===c.id)?a+it.count:a, 0);
        let color = has>=c.n?'#66bb6a':'#ef5350';
        let costItem = ITEM_DATA[c.id];
        let name = costItem ? costItem.name : 'Desconhecido';
        return `<div class="cost-item" style="color:${color}"><span>${name}</span><span>${has}/${c.n}</span></div>`;
    }).join('');
    t.innerHTML = `<h4>${itemInfo.name}</h4>${costs}${extraText}`;
}
function hideTooltip() { document.getElementById('tooltip').style.display='none'; }

// Helpers
function dropItem(x, y, id, count) { gameState.droppedItems.push(new DroppedItem(x, y, id, count)); }
function respawnPlayer() { 
    gameState.player.y=0; 
    gameState.player.health=100; 
    gameState.player.hunger=20; 
    showMessage("Voc√™ morreu!"); 
    updateUI(); 
}
function addParticle(x,y,c,n) { for(let i=0;i<n;i++) gameState.particles.push({x:x,y:y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:20,color:c,size:3}); }
function shootProjectile(sx, sy, tx, ty, owner) { let angle = Math.atan2(ty - sy, tx - sx); gameState.projectiles.push({ x:sx, y:sy, vx:Math.cos(angle)*10, vy:Math.sin(angle)*10, owner:owner, life:50, update:function(){this.x+=this.vx;this.y+=this.vy;this.life--; addParticle(this.x,this.y,'#0ff',1);} }); }
function checkRectOverlap(r1, r2) { return r1.x < r2.x+r2.w && r1.x+r1.w > r2.x && r1.y < r2.y+r2.h && r1.y+r1.h > r2.y; }
function handleTrashDrop() { if(gameState.cursorItem) { gameState.cursorItem=null; updateInventoryUI(); } }
function shadeColor(color, percent) { if(!color) return '#000'; if(color[0]==='#') { var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF; return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1); } return color; }
function showMessage(t) { let el=document.getElementById('message-area'); el.innerText=t; el.style.opacity=1; setTimeout(()=>el.style.opacity=0, 2000); }

window.addEventListener('keydown',e=>{input.keys[e.code]=true; if(e.key>='1'&&e.key<='9'){gameState.player.selectedSlot=parseInt(e.key)-1;updateInventoryUI();}});
window.addEventListener('keyup',e=>input.keys[e.code]=false);
window.addEventListener('mousemove',e=>{input.mouseX=e.clientX; input.mouseY=e.clientY;});
window.addEventListener('mousedown',e=>{if(e.button===0)input.click=true; if(e.button===2)input.rightClick=true;});
window.addEventListener('mouseup',e=>{input.click=false; input.rightClick=false;});
window.addEventListener('contextmenu',e=>e.preventDefault());
window.addEventListener('resize', () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; });
canvas.width=window.innerWidth; canvas.height=window.innerHeight;

const hg = document.getElementById('hero-grid');
HEROES.forEach(h => {
    let b = document.createElement('div'); b.className = 'hero-btn';
    b.innerHTML = `<div style="width:20px;height:20px;background:${h.color};margin-bottom:5px;"></div><div>${h.name}</div>`;
    b.onclick = () => initGame(h.name, h.color);
    hg.appendChild(b);
});

</script>
</body>
</html>